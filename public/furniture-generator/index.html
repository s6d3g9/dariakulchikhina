<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>3D Furniture ‚Äî Voxel Editor + Preview</title>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  LIQUID GLASS THEME  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root{
  --g-bg:rgba(255,255,255,.48);
  --g-border:rgba(255,255,255,.55);
  --g-shadow:0 10px 28px rgba(18,18,18,.08);
  --g-text:#1f1f1f;
  --g-muted:rgba(31,31,31,.52);
  --g-page:#f3f4f6;
  --g-accent:rgba(31,31,31,.82);
  --g-accent-solid:#1f1f1f;
  --g-danger:#d44;
  --blur:blur(18px) saturate(145%);
  --blur-sm:blur(10px) saturate(130%);
  --radius:10px;
  --radius-sm:6px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;
  background:var(--g-page);color:var(--g-text);
  font-family:"Inter","SF Pro Display","Segoe UI","Roboto",sans-serif}

/* ‚îÄ‚îÄ page gradient backdrop ‚îÄ‚îÄ */
#app{display:grid;width:100%;height:100%;position:relative;isolation:isolate;
  grid-template-columns:300px 1fr 1fr;grid-template-rows:auto 1fr auto}
#app::before{content:"";position:absolute;inset:0;z-index:-1;pointer-events:none;
  background:
    radial-gradient(70% 55% at 0% 0%,rgba(255,255,255,.32),transparent 62%),
    radial-gradient(70% 50% at 100% 100%,rgba(255,255,255,.2),transparent 65%)}

/* ‚îÄ‚îÄ top category bar ‚îÄ‚îÄ */
#cats{grid-column:1/4;display:flex;
  background:var(--g-bg);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-bottom:1px solid var(--g-border)}
.cat-btn{flex:1;padding:10px 4px;font:inherit;font-size:10px;letter-spacing:.08em;
  text-transform:uppercase;background:transparent;border:none;
  border-right:1px solid var(--g-border);color:var(--g-muted);cursor:pointer;
  transition:all .2s}
.cat-btn:last-child{border-right:none}
.cat-btn.active{background:var(--g-accent);color:#fff;
  text-shadow:0 1px 3px rgba(0,0,0,.15);font-weight:600}
.cat-btn:hover:not(.active){background:rgba(31,31,31,.06);color:var(--g-text)}

/* ‚îÄ‚îÄ left panel ‚îÄ‚îÄ */
#left{grid-column:1;grid-row:2;overflow-y:auto;display:flex;flex-direction:column;
  background:var(--g-bg);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-right:1px solid var(--g-border)}
.sec{padding:9px 12px;border-bottom:1px solid var(--g-border)}
.sec-head{font-size:9px;letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px;
  color:var(--g-muted);font-weight:600}

/* ‚îÄ‚îÄ palette buttons ‚îÄ‚îÄ */
.pal-row{display:flex;flex-wrap:wrap;gap:4px}
.pal-btn{display:flex;align-items:center;gap:5px;padding:4px 8px;font:inherit;font-size:8.5px;
  letter-spacing:.04em;text-transform:uppercase;
  border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.55);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  cursor:pointer;transition:all .18s;line-height:1.2;color:var(--g-text)}
.pal-btn .sw{width:11px;height:11px;border:1px solid rgba(0,0,0,.15);border-radius:3px;flex-shrink:0}
.pal-btn.active{background:var(--g-accent);color:#fff;border-color:rgba(31,31,31,.3);
  box-shadow:0 2px 8px rgba(0,0,0,.12)}
.pal-btn.active .sw{border-color:rgba(255,255,255,.5)}
.pal-btn:hover:not(.active){background:rgba(31,31,31,.06);border-color:rgba(31,31,31,.18)}

/* ‚îÄ‚îÄ preset buttons ‚îÄ‚îÄ */
.preset-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
.preset-btn{padding:4px 9px;font:inherit;font-size:8px;letter-spacing:.05em;text-transform:uppercase;
  border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.45);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  cursor:pointer;transition:all .18s;line-height:1.2;color:var(--g-text)}
.preset-btn:hover{background:rgba(31,31,31,.06);border-color:rgba(31,31,31,.18)}
.preset-btn.active{background:var(--g-accent);color:#fff;border-color:rgba(31,31,31,.3);
  box-shadow:0 2px 8px rgba(0,0,0,.12)}

/* ‚îÄ‚îÄ dimensions ‚îÄ‚îÄ */
.dim-row{display:flex;gap:6px;margin-bottom:5px;flex-wrap:wrap;align-items:center}
.dim-row label{font-size:9px;text-transform:uppercase;letter-spacing:.05em;display:flex;
  align-items:center;gap:4px;color:var(--g-muted)}
.dim-row input{width:52px;font:inherit;font-size:13px;text-align:center;
  border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.6);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  padding:3px 2px;color:var(--g-text);transition:border-color .15s}
.dim-row input:focus{outline:none;border-color:rgba(31,31,31,.35);
  box-shadow:0 0 0 2px rgba(31,31,31,.08)}
.dim-auto{display:flex;gap:12px;margin-top:3px;padding:5px 0;
  border-top:1px solid var(--g-border);font-size:9px;text-transform:uppercase;
  letter-spacing:.05em;color:var(--g-muted)}
.dim-auto .val{font-weight:700;font-size:12px;color:var(--g-text)}

/* ‚îÄ‚îÄ toggle buttons ‚îÄ‚îÄ */
.tog-row{display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap}
.tog-btn{display:flex;align-items:center;gap:5px;padding:4px 8px;font:inherit;font-size:8.5px;
  letter-spacing:.06em;text-transform:uppercase;
  border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.45);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  cursor:pointer;transition:all .18s;line-height:1.2;color:var(--g-muted)}
.tog-btn .indicator{width:10px;height:10px;border:1.5px solid var(--g-border);
  border-radius:3px;background:transparent;flex-shrink:0;transition:all .18s}
.tog-btn.on .indicator{background:var(--g-accent-solid);border-color:var(--g-accent-solid);
  box-shadow:0 0 6px rgba(0,0,0,.15)}
.tog-btn.on{color:var(--g-text);border-color:rgba(31,31,31,.2)}
.tog-btn:hover{background:rgba(31,31,31,.05)}

/* ‚îÄ‚îÄ viewports ‚îÄ‚îÄ */
.viewport-wrap{position:relative;overflow:hidden;background:var(--g-page)}
.viewport-wrap canvas{display:block;width:100%;height:100%}
#editor-vp canvas{cursor:default}
#editor-vp canvas.brush-mode{cursor:crosshair}
#editor-vp canvas.eraser-mode{cursor:crosshair}
.handle-mesh{cursor:grab}
.vp-label{position:absolute;top:8px;left:50%;transform:translateX(-50%);
  font:inherit;font-size:9px;letter-spacing:.1em;text-transform:uppercase;
  color:var(--g-muted);pointer-events:none;
  background:var(--g-bg);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  padding:3px 12px;border-radius:var(--radius-sm);border:1px solid var(--g-border)}
#editor-vp{grid-column:2;grid-row:2;border-right:1px solid var(--g-border)}
#preview-vp{grid-column:3;grid-row:2}
#click-hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);
  font:inherit;font-size:8px;letter-spacing:.06em;text-transform:uppercase;
  color:var(--g-muted);pointer-events:none;
  background:var(--g-bg);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  padding:3px 10px;border-radius:var(--radius-sm);border:1px solid var(--g-border)}
#drag-hint{position:absolute;top:30px;left:50%;transform:translateX(-50%);
  font:inherit;font-size:10px;letter-spacing:.06em;text-transform:uppercase;
  color:#e07a5f;pointer-events:none;
  background:rgba(255,255,255,.85);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  padding:4px 12px;border-radius:var(--radius-sm);border:1px solid rgba(224,122,95,.35);display:none}

/* ‚îÄ‚îÄ bottom bar ‚îÄ‚îÄ */
#bar{grid-column:1/4;
  background:var(--g-bg);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-top:1px solid var(--g-border);
  display:flex;align-items:center;padding:6px 16px;gap:14px;flex-wrap:wrap}
#bar .info{font-size:10px;letter-spacing:.06em;text-transform:uppercase;color:var(--g-muted)}
#bar .info span{font-weight:700;color:var(--g-text)}
#bar .spacer{flex:1}
.bar-btn{font:inherit;font-size:10px;letter-spacing:.08em;text-transform:uppercase;
  padding:6px 14px;border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.55);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  cursor:pointer;transition:all .18s;color:var(--g-text)}
.bar-btn:hover{background:var(--g-accent);color:#fff;border-color:rgba(31,31,31,.3);
  box-shadow:0 2px 10px rgba(0,0,0,.12)}

/* ‚îÄ‚îÄ selection panel ‚îÄ‚îÄ */
#sel-panel{display:none}
#sel-panel.open{display:block}
#sel-panel .sel-head{display:flex;align-items:center;gap:6px;margin-bottom:6px}
#sel-panel .sel-head .sw{width:14px;height:14px;border:1px solid rgba(0,0,0,.12);border-radius:3px;flex-shrink:0}
#sel-panel .sel-head .sel-name{font-size:10px;font-weight:700;text-transform:uppercase;
  letter-spacing:.06em;color:var(--g-text)}
#sel-panel .sel-dims{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
#sel-panel .sel-dims label{font-size:9px;text-transform:uppercase;letter-spacing:.05em;
  display:flex;align-items:center;gap:4px;color:var(--g-muted)}
#sel-panel .sel-dims input{width:52px;font:inherit;font-size:13px;text-align:center;
  border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.6);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  padding:3px 2px;color:var(--g-text)}
#sel-panel .sel-dims input:focus{outline:none;border-color:rgba(31,31,31,.35);
  box-shadow:0 0 0 2px rgba(31,31,31,.08)}
.sel-actions{display:flex;gap:5px;margin-top:7px}
.sel-btn{padding:4px 10px;font:inherit;font-size:8.5px;letter-spacing:.06em;text-transform:uppercase;
  border:1px solid var(--g-border);border-radius:var(--radius-sm);
  background:rgba(255,255,255,.55);backdrop-filter:var(--blur-sm);-webkit-backdrop-filter:var(--blur-sm);
  cursor:pointer;transition:all .18s;line-height:1.2;color:var(--g-text)}
.sel-btn:hover{background:var(--g-accent);color:#fff;border-color:rgba(31,31,31,.3)}
.sel-btn.danger{border-color:rgba(204,68,68,.35);color:var(--g-danger)}
.sel-btn.danger:hover{background:rgba(204,68,68,.8);color:#fff;border-color:rgba(204,68,68,.5)}

/* ‚îÄ‚îÄ scrollbar ‚îÄ‚îÄ */
#left::-webkit-scrollbar{width:4px}
#left::-webkit-scrollbar-thumb{background:rgba(31,31,31,.2);border-radius:4px}
#left::-webkit-scrollbar-track{background:transparent}

/* ‚îÄ‚îÄ export overlay ‚îÄ‚îÄ */
#export-overlay{display:none;position:fixed;inset:0;z-index:9999;
  background:rgba(0,0,0,.45);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  justify-content:center;align-items:center}
#export-overlay.open{display:flex}
#export-card{background:var(--g-bg);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--g-border);border-radius:var(--radius);
  box-shadow:var(--g-shadow);padding:22px;max-width:95vw;max-height:95vh;overflow:auto;position:relative}
#export-card canvas{display:block;margin:0 auto 14px;border-radius:var(--radius-sm)}
#export-close{position:absolute;top:8px;right:12px;font:inherit;font-size:18px;
  background:none;border:none;cursor:pointer;color:var(--g-muted);transition:color .15s}
#export-close:hover{color:var(--g-text)}
#export-actions{display:flex;gap:8px;justify-content:center}
#export-actions .bar-btn{font-size:11px;padding:7px 18px}
</style>
</head>
<body>
<div id="app">
  <div id="cats">
    <button class="cat-btn active" data-cat="wardrobe">–®–∫–∞—Ñ-–∫—É–ø–µ</button>
    <button class="cat-btn" data-cat="bookcase">–ö–Ω–∏–∂–Ω—ã–π —à–∫–∞—Ñ</button>
    <button class="cat-btn" data-cat="shoes">–û–±—É–≤–Ω–æ–π —à–∫–∞—Ñ</button>
    <button class="cat-btn" data-cat="hallway">–ü—Ä–∏—Ö–æ–∂–∞—è</button>
    <button class="cat-btn" data-cat="shelving">–°—Ç–µ–ª–ª–∞–∂</button>
    <button class="cat-btn" data-cat="kitchen">–ö—É—Ö–Ω—è</button>
    <button class="cat-btn" data-cat="closet">–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è</button>
  </div>
  <div id="left">
    <div class="sec" id="palette">
      <h3 class="sec-head">–¢–∏–ø –æ—Ç–¥–µ–ª–µ–Ω–∏—è</h3>
      <div class="pal-row" id="pal-row"></div>
      <div style="margin-top:4px;display:flex;gap:4px">
        <button class="pal-btn" id="cursor-btn" style="border-color:#ff6600">
          <span class="sw" style="background:#ff6600"></span>–ö—É—Ä—Å–æ—Ä
        </button>
        <button class="pal-btn" id="eraser-btn" style="border-style:dashed">
          <span class="sw" style="background:#fff"></span>–õ–∞—Å—Ç–∏–∫
        </button>
      </div>
      <h3 class="sec-head" style="margin-top:8px">–ü—Ä–µ—Å–µ—Ç—ã</h3>
      <div class="preset-row" id="preset-row"></div>
    </div>
    <div class="sec">
      <h3 class="sec-head">–†–∞–∑–º–µ—Ä—ã (—Å–º) ¬∑ 1 –∫—É–± = 10 —Å–º</h3>
      <div class="dim-row">
        <label>–® <input type="number" id="roomW" value="400" min="100" max="1200" step="10"/></label>
        <label>–ì <input type="number" id="roomD" value="400" min="100" max="1200" step="10"/></label>
      </div>
      <div class="dim-row"><label>–í <input type="number" id="dimH" value="240" min="30" max="350" step="10"/></label></div>
      <div class="dim-auto" style="font-size:8px;color:#777">
        –°–µ—Ç–∫–∞: <span class="val" id="grid-info" style="font-size:10px">‚Äî</span>
      </div>
      <div class="dim-auto">
        <div>–ú–µ–±–µ–ª—å –®: <span class="val" id="auto-w">‚Äî</span></div>
        <div>–ì: <span class="val" id="auto-d">‚Äî</span></div>
        <div>–í: <span class="val" id="auto-h">‚Äî</span></div>
      </div>
    </div>
    <div class="sec" id="sel-panel">
      <h3 class="sec-head">–í—ã–±—Ä–∞–Ω–Ω—ã–π –±–ª–æ–∫</h3>
      <div class="sel-head">
        <span class="sw" id="sel-color"></span>
        <span class="sel-name" id="sel-name">‚Äî</span>
      </div>
      <div class="sel-dims">
        <label>–® <input type="number" id="sel-w" value="0" min="10" max="1200" step="10"/> —Å–º</label>
        <label>–í <input type="number" id="sel-h" value="0" min="10" max="350" step="10"/> —Å–º</label>
        <label>–ì <input type="number" id="sel-d" value="0" min="10" max="1200" step="10"/> —Å–º</label>
      </div>
      <div class="sel-actions">
        <button class="sel-btn" id="sel-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="sel-btn danger" id="sel-delete">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="sel-btn" id="sel-deselect">‚úï –°–Ω—è—Ç—å</button>
      </div>
    </div>
    <div class="sec">
      <h3 class="sec-head">–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —Ñ–∞—Å–∞–¥–æ–≤</h3>
      <div class="tog-row">
        <button class="tog-btn on" id="front-auto" data-front="auto"><span class="indicator"></span>–ê–≤—Ç–æ</button>
        <button class="tog-btn" id="front-pz" data-front="pz"><span class="indicator"></span>–ö –Ω–∞–º (+Z)</button>
        <button class="tog-btn" id="front-nz" data-front="nz"><span class="indicator"></span>–û—Ç –Ω–∞—Å (‚àíZ)</button>
        <button class="tog-btn" id="front-px" data-front="px"><span class="indicator"></span>–í–ø—Ä–∞–≤–æ (+X)</button>
        <button class="tog-btn" id="front-nx" data-front="nx"><span class="indicator"></span>–í–ª–µ–≤–æ (‚àíX)</button>
      </div>
    </div>
    <div class="sec">
      <h3 class="sec-head">–î–µ–ª–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π</h3>
      <div class="tog-row">
        <button class="tog-btn on" id="tog-h"><span class="indicator"></span>–ü–æ –≤—ã—Å–æ—Ç–µ</button>
        <button class="tog-btn on" id="tog-w"><span class="indicator"></span>–ü–æ —à–∏—Ä–∏–Ω–µ</button>
        <button class="tog-btn on" id="tog-d"><span class="indicator"></span>–ü–æ –≥–ª—É–±–∏–Ω–µ</button>
      </div>
      <div id="subdiv-inputs">
        <div class="dim-row subdiv-for" data-for="1"><label>–ü–æ–ª–∫–∞ <input type="number" id="shelfH" value="30" min="10" max="120" step="5"/> —Å–º</label></div>
        <div class="dim-row subdiv-for" data-for="3"><label>–Ø—â–∏–∫ <input type="number" id="drawerH" value="20" min="8" max="80" step="2"/> —Å–º</label></div>
        <div class="dim-row subdiv-for" data-for="4"><label>–û—Ç–∫—Ä—ã—Ç–∞—è <input type="number" id="openH" value="35" min="10" max="120" step="5"/> —Å–º</label></div>
        <div class="dim-row subdiv-for" data-for="5"><label>–û–±—É–≤—å <input type="number" id="shoeH" value="18" min="8" max="60" step="2"/> —Å–º</label></div>
        <div class="dim-row subdiv-for" data-for="6"><label>–°–∞–ø–æ–≥–∏ <input type="number" id="bootH" value="35" min="15" max="80" step="5"/> —Å–º</label></div>
        <div class="dim-row subdiv-for" data-for="7"><label>–ö–Ω–∏–≥–∏ <input type="number" id="bookH" value="30" min="10" max="80" step="5"/> —Å–º</label></div>
      </div>
    </div>
  </div>
  <div id="editor-vp" class="viewport-wrap">
    <div class="vp-label">–†–µ–¥–∞–∫—Ç–æ—Ä (–∫—É–±–∏–∫–∏)</div>
    <div id="click-hint">–ö–∏—Å—Ç—å: –õ–ö–ú ‚Äî 1 –∫—É–±, —Ç—è–Ω—É—Ç—å ‚Äî –±–ª–æ–∫, —Å–∫—Ä–æ–ª–ª ‚Äî –≥–ª—É–±–∏–Ω–∞ ¬∑ –ö—É—Ä—Å–æ—Ä: –∫–ª–∏–∫ ‚Äî –≤—ã–±—Ä–∞—Ç—å, —Ö–≤–∞—Ç–∞—Ç—å —Ä—É—á–∫–∏ ‚Äî —Ä–∞–∑–º–µ—Ä, Del ‚Äî —É–¥–∞–ª–∏—Ç—å</div>
    <div id="drag-hint"></div>
  </div>
  <div id="preview-vp" class="viewport-wrap">
    <div class="vp-label">3D –º–æ–¥–µ–ª—å</div>
  </div>
  <div id="bar">
    <div class="info">–°–µ–∫—Ü–∏–π: <span id="info-regions">0</span></div>
    <div class="info">–†–∞–∑–º–µ—Ä: <span id="info-size">‚Äî</span></div>
    <div class="spacer"></div>
    <button class="bar-btn" id="btn-save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ —Ñ–∞–π–ª">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="bar-btn" id="btn-load" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ñ–∞–π–ª–∞">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <input type="file" id="file-input" accept=".json" style="display:none"/>
    <button class="bar-btn" id="btn-export" title="–≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä—Ç–µ–∂–∞ PNG">üìê –ß–µ—Ä—Ç—ë–∂</button>
    <button class="bar-btn" id="btn-undo">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å</button>
    <button class="bar-btn" id="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button class="bar-btn" id="btn-reset-cam">–°–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã</button>
  </div>
</div>
<!-- export overlay -->
<div id="export-overlay">
  <div id="export-card">
    <button id="export-close">‚úï</button>
    <canvas id="export-canvas"></canvas>
    <div id="export-actions">
      <button class="bar-btn" id="export-download">üíæ –°–∫–∞—á–∞—Ç—å PNG</button>
      <button class="bar-btn" id="export-dxf">üìê –°–∫–∞—á–∞—Ç—å DXF (AutoCAD)</button>
    </div>
  </div>
</div>

<script type="importmap">
{"imports":{
  "three":"https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js",
  "three/addons/":"https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/"
}}
</script>
<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  TYPES  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TYPES={
  shelf:{id:1,label:'–ü–æ–ª–∫–∞',color:'#a8d8ea'},
  hanging:{id:2,label:'–®—Ç–∞–Ω–≥–∞',color:'#b5eaaa'},
  drawer:{id:3,label:'–Ø—â–∏–∫',color:'#f5c385'},
  open:{id:4,label:'–û—Ç–∫—Ä—ã—Ç–∞—è',color:'#fff3b0'},
  shoeLow:{id:5,label:'–û–±—É–≤—å –Ω–∏–∑–∫–∞—è',color:'#f0b0c0'},
  shoeHi:{id:6,label:'–°–∞–ø–æ–≥–∏',color:'#d5b0f0'},
  books:{id:7,label:'–ö–Ω–∏–≥–∏',color:'#b0d0f0'},
  top:{id:8,label:'–ê–Ω—Ç—Ä–µ—Å–æ–ª—å',color:'#d0d0d0'},
  sink:{id:9,label:'–ú–æ–π–∫–∞',color:'#8ecae6'},
  cooktop:{id:10,label:'–í–∞—Ä–æ—á–Ω–∞—è',color:'#e07a5f'},
  oven:{id:11,label:'–î—É—Ö–æ–≤–∫–∞',color:'#c97b3d'},
  dishw:{id:12,label:'–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞',color:'#81b29a'},
  door:{id:13,label:'–î–≤–µ—Ä—å',color:'#c8b896'},
  doorGlass:{id:14,label:'–°—Ç–µ–∫–ª. –¥–≤–µ—Ä—å',color:'#b8d8e8'},
};
const TYPE_BY_ID={};
for(const[k,v]of Object.entries(TYPES)) TYPE_BY_ID[v.id]={...v,key:k};
const CAT_TYPES={
  wardrobe:['shelf','hanging','drawer','open','top','door','doorGlass'],
  bookcase:['books','shelf','drawer','open','door','doorGlass'],
  shoes:['shoeLow','shoeHi','drawer','shelf','door'],
  hallway:['hanging','shoeLow','shoeHi','drawer','shelf','open','door','doorGlass'],
  shelving:['shelf','open','books','drawer','door','doorGlass'],
  kitchen:['shelf','drawer','open','top','sink','cooktop','oven','dishw','door'],
  closet:['shelf','hanging','drawer','open','top','shoeLow','shoeHi','door','doorGlass'],
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  VOXEL GRID  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CELL=0.1; // 10cm in metres
const GAP=0.003; // tiny gap between blocks to avoid z-fighting
let GX=40, GY=24, GZ=40; // default 400√ó240√ó400 cm
let voxels=new Uint8Array(GX*GY*GZ);
const vIdx=(x,y,z)=>x+y*GX+z*GX*GY;
const vGet=(x,y,z)=>(x<0||x>=GX||y<0||y>=GY||z<0||z>=GZ)?0:voxels[vIdx(x,y,z)];
const vSet=(x,y,z,v)=>{voxels[vIdx(x,y,z)]=v};
const vClear=()=>voxels.fill(0);
function fillBox(x1,y1,z1,x2,y2,z2,v){
  for(let z=Math.max(0,z1);z<=Math.min(GZ-1,z2);z++)
    for(let y=Math.max(0,y1);y<=Math.min(GY-1,y2);y++)
      for(let x=Math.max(0,x1);x<=Math.min(GX-1,x2);x++) vSet(x,y,z,v)}

function recomputeGrid(){
  const ngx=Math.max(4,Math.round((+roomWEl.value||400)/10));
  const ngy=Math.max(4,Math.round((+dimHEl.value||240)/10));
  const ngz=Math.max(4,Math.round((+roomDEl.value||400)/10));
  if(ngx===GX&&ngy===GY&&ngz===GZ)return false;
  GX=ngx;GY=ngy;GZ=ngz;
  voxels=new Uint8Array(GX*GY*GZ);
  $('grid-info').textContent=`${GX}√ó${GY}√ó${GZ}`;
  return true;
}

/* helper for proportional presets */
const fr=(f,mx)=>Math.round(f*(mx-1));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  PRESETS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const T=TYPES;
const CATEGORY_PRESETS={
  wardrobe:[
    {name:'–ö–ª–∞—Å—Å–∏–∫–∞',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.3,GY),0,fr(.47,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.53,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.53,GX),fr(.3,GY),0,GX-1,fr(.5,GY),d,T.shelf.id);
      fillBox(0,fr(.15,GY),0,fr(.47,GX),fr(.25,GY),d,T.drawer.id);
      fillBox(fr(.53,GX),fr(.15,GY),0,GX-1,fr(.25,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.1,GY),d,T.shelf.id)}},
    {name:'–ö–æ–º–ø–∞–∫—Ç',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.25,GY),0,GX-1,fr(.85,GY),d,T.hanging.id);
      fillBox(0,fr(.1,GY),0,GX-1,fr(.2,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.08,GY),d,T.shelf.id)}},
    {name:'–û—Ä–≥–∞–Ω–∞–π–∑–µ—Ä',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.5,GY),0,fr(.25,GX),fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.3,GX),fr(.5,GY),0,fr(.7,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.75,GX),fr(.5,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(0,fr(.25,GY),0,fr(.25,GX),fr(.45,GY),d,T.drawer.id);
      fillBox(fr(.3,GX),fr(.25,GY),0,fr(.7,GX),fr(.45,GY),d,T.shelf.id);
      fillBox(fr(.75,GX),fr(.25,GY),0,GX-1,fr(.45,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.2,GY),d,T.shelf.id)}},
    {name:'–î–≤–µ —à—Ç–∞–Ω–≥–∏',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.5,GY),0,GX-1,fr(.85,GY),d,T.hanging.id);
      fillBox(0,fr(.1,GY),0,GX-1,fr(.45,GY),d,T.hanging.id);
      fillBox(0,0,0,GX-1,fr(.08,GY),d,T.shelf.id)}},
    {name:'–ü-–æ–±—Ä–∞–∑–Ω—ã–π',fill:()=>{const d=Math.min(5,GZ-1);const ld=Math.min(12,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);fillBox(0,fr(.9,GY),0,fr(.15,GX),GY-1,ld,T.top.id);fillBox(fr(.85,GX),fr(.9,GY),0,GX-1,GY-1,ld,T.top.id);
      fillBox(0,fr(.3,GY),0,fr(.47,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.53,GX),fr(.3,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(0,fr(.3,GY),0,fr(.15,GX),fr(.85,GY),ld,T.shelf.id);
      fillBox(fr(.85,GX),fr(.3,GY),0,GX-1,fr(.85,GY),ld,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.drawer.id)}},
    {name:'–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.55,GY),0,fr(.32,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.36,GX),fr(.55,GY),0,fr(.64,GX),fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.68,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.hanging.id);
      fillBox(0,fr(.3,GY),0,fr(.32,GX),fr(.5,GY),d,T.drawer.id);
      fillBox(fr(.36,GX),fr(.3,GY),0,fr(.64,GX),fr(.5,GY),d,T.open.id);
      fillBox(fr(.68,GX),fr(.3,GY),0,GX-1,fr(.5,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.shelf.id)}},
  ],
  bookcase:[
    {name:'–ö–ª–∞—Å—Å–∏–∫–∞',fill:()=>{const d=Math.min(3,GZ-1);const rows=5;
      for(let i=0;i<rows;i++){const y1=fr(i/rows,GY),y2=fr((i+1)/rows,GY)-1;fillBox(0,y1,0,GX-1,y2,d,T.books.id)}}},
    {name:'–° —è—â–∏–∫–∞–º–∏',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.2,GY),0,GX-1,GY-1,d,T.books.id);
      fillBox(0,0,0,GX-1,fr(.18,GY),d,T.drawer.id)}},
    {name:'–°–º–µ—à–∞–Ω–Ω—ã–π',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.6,GY),0,fr(.5,GX),GY-1,d,T.books.id);
      fillBox(fr(.55,GX),fr(.6,GY),0,GX-1,GY-1,d,T.open.id);
      fillBox(0,fr(.3,GY),0,fr(.5,GX),fr(.55,GY),d,T.books.id);
      fillBox(fr(.55,GX),fr(.3,GY),0,GX-1,fr(.55,GY),d,T.shelf.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.drawer.id)}},
    {name:'–î–≤—É—Ö—Å–µ–∫—Ü–∏–æ–Ω–Ω—ã–π',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.5,GY),0,fr(.47,GX),GY-1,d,T.books.id);
      fillBox(fr(.53,GX),fr(.5,GY),0,GX-1,GY-1,d,T.books.id);
      fillBox(0,0,0,fr(.47,GX),fr(.45,GY),d,T.books.id);
      fillBox(fr(.53,GX),0,0,GX-1,fr(.45,GY),d,T.books.id)}},
    {name:'–í–∏—Ç—Ä–∏–Ω–∞',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.7,GY),0,GX-1,GY-1,d,T.open.id);
      fillBox(0,fr(.35,GY),0,GX-1,fr(.65,GY),d,T.books.id);
      fillBox(0,0,0,GX-1,fr(.3,GY),d,T.shelf.id)}},
    {name:'–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.75,GY),0,GX-1,GY-1,d,T.books.id);
      fillBox(0,fr(.5,GY),0,fr(.47,GX),fr(.7,GY),d,T.books.id);
      fillBox(fr(.53,GX),fr(.5,GY),0,GX-1,fr(.7,GY),d,T.open.id);
      fillBox(0,fr(.25,GY),0,GX-1,fr(.45,GY),d,T.books.id);
      fillBox(0,0,0,fr(.47,GX),fr(.2,GY),d,T.drawer.id);
      fillBox(fr(.53,GX),0,0,GX-1,fr(.2,GY),d,T.drawer.id)}},
  ],
  shoes:[
    {name:'–ö–ª–∞—Å—Å–∏–∫–∞',fill:()=>{const d=Math.min(4,GZ-1);
      fillBox(0,fr(.7,GY),0,GX-1,GY-1,d,T.shoeHi.id);
      fillBox(0,fr(.3,GY),0,GX-1,fr(.65,GY),d,T.shoeLow.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.drawer.id)}},
    {name:'–ö–æ–º–ø–∞–∫—Ç',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.5,GY),0,GX-1,GY-1,d,T.shoeLow.id);
      fillBox(0,0,0,GX-1,fr(.45,GY),d,T.drawer.id)}},
    {name:'–í—ã—Å–æ–∫–∞—è',fill:()=>{const d=Math.min(4,GZ-1);
      fillBox(0,fr(.75,GY),0,GX-1,GY-1,d,T.shoeHi.id);
      fillBox(0,fr(.5,GY),0,GX-1,fr(.7,GY),d,T.shoeHi.id);
      fillBox(0,fr(.25,GY),0,GX-1,fr(.45,GY),d,T.shoeLow.id);
      fillBox(0,0,0,GX-1,fr(.2,GY),d,T.shoeLow.id)}},
    {name:'–° –ø–æ–ª–∫–∞–º–∏',fill:()=>{const d=Math.min(4,GZ-1);
      fillBox(0,fr(.8,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,fr(.5,GY),0,GX-1,fr(.75,GY),d,T.shoeHi.id);
      fillBox(0,fr(.2,GY),0,GX-1,fr(.45,GY),d,T.shoeLow.id);
      fillBox(0,0,0,GX-1,fr(.15,GY),d,T.drawer.id)}},
    {name:'–î–≤—É—Ö—Å–µ–∫—Ü–∏–æ–Ω–Ω–∞—è',fill:()=>{const d=Math.min(4,GZ-1);
      fillBox(0,fr(.5,GY),0,fr(.47,GX),GY-1,d,T.shoeHi.id);
      fillBox(fr(.53,GX),fr(.5,GY),0,GX-1,GY-1,d,T.shoeLow.id);
      fillBox(0,0,0,fr(.47,GX),fr(.45,GY),d,T.shoeLow.id);
      fillBox(fr(.53,GX),0,0,GX-1,fr(.45,GY),d,T.drawer.id)}},
  ],
  hallway:[
    {name:'–ö–ª–∞—Å—Å–∏–∫–∞',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.4,GY),0,fr(.55,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.6,GX),fr(.4,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(0,fr(.2,GY),0,GX-1,fr(.35,GY),d,T.shoeLow.id);
      fillBox(0,0,0,GX-1,fr(.15,GY),d,T.drawer.id)}},
    {name:'–û—Ç–∫—Ä—ã—Ç–∞—è',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.3,GY),0,GX-1,fr(.85,GY),d,T.open.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.shoeLow.id)}},
    {name:'–£–≥–ª–æ–≤–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const ld=Math.min(12,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);fillBox(0,fr(.9,GY),0,fr(.15,GX),GY-1,ld,T.top.id);
      fillBox(0,fr(.3,GY),0,GX-1,fr(.85,GY),d,T.hanging.id);fillBox(0,fr(.3,GY),0,fr(.15,GX),fr(.85,GY),ld,T.shelf.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.shoeLow.id);fillBox(0,0,0,fr(.15,GX),fr(.25,GY),ld,T.drawer.id)}},
    {name:'–° –∑–µ—Ä–∫–∞–ª–æ–º',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.35,GY),0,fr(.3,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.35,GX),fr(.35,GY),0,fr(.65,GX),fr(.85,GY),d,T.open.id);
      fillBox(fr(.7,GX),fr(.35,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(0,0,0,GX-1,fr(.3,GY),d,T.shoeLow.id)}},
    {name:'–£–∑–∫–∞—è',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.85,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,fr(.45,GY),0,GX-1,fr(.8,GY),d,T.hanging.id);
      fillBox(0,fr(.2,GY),0,GX-1,fr(.4,GY),d,T.shoeLow.id);
      fillBox(0,0,0,GX-1,fr(.15,GY),d,T.drawer.id)}},
    {name:'–°–µ–º–µ–π–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.4,GY),0,fr(.3,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.35,GX),fr(.6,GY),0,fr(.65,GX),fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.35,GX),fr(.4,GY),0,fr(.65,GX),fr(.55,GY),d,T.drawer.id);
      fillBox(fr(.7,GX),fr(.4,GY),0,GX-1,fr(.85,GY),d,T.hanging.id);
      fillBox(0,fr(.15,GY),0,fr(.3,GX),fr(.35,GY),d,T.shoeHi.id);
      fillBox(fr(.35,GX),fr(.15,GY),0,fr(.65,GX),fr(.35,GY),d,T.shoeLow.id);
      fillBox(fr(.7,GX),fr(.15,GY),0,GX-1,fr(.35,GY),d,T.shoeHi.id);
      fillBox(0,0,0,GX-1,fr(.1,GY),d,T.shelf.id)}},
  ],
  shelving:[
    {name:'–ö–ª–∞—Å—Å–∏–∫–∞',fill:()=>{const d=Math.min(3,GZ-1);const rows=5;
      for(let i=0;i<rows;i++){const y1=fr(i/rows,GY),y2=fr((i+1)/rows,GY)-1;
        fillBox(0,y1,0,GX-1,y2,d,i%2===0?T.open.id:T.shelf.id)}}},
    {name:'–°–∏–º–º–µ—Ç—Ä–∏—è',fill:()=>{const d=Math.min(3,GZ-1);const rows=5;
      for(let i=0;i<rows;i++){const y1=fr(i/rows,GY),y2=fr((i+1)/rows,GY)-1;
        fillBox(0,y1,0,GX-1,y2,d,T.shelf.id)}}},
    {name:'–° —è—â–∏–∫–∞–º–∏',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.4,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,fr(.2,GY),0,GX-1,fr(.35,GY),d,T.open.id);
      fillBox(0,0,0,GX-1,fr(.15,GY),d,T.drawer.id)}},
    {name:'–ê—Å–∏–º–º–µ—Ç—Ä–∏—è',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.75,GY),0,fr(.47,GX),GY-1,d,T.shelf.id);
      fillBox(fr(.53,GX),fr(.75,GY),0,GX-1,GY-1,d,T.open.id);
      fillBox(0,fr(.5,GY),0,fr(.47,GX),fr(.7,GY),d,T.open.id);
      fillBox(fr(.53,GX),fr(.5,GY),0,GX-1,fr(.7,GY),d,T.shelf.id);
      fillBox(0,fr(.25,GY),0,fr(.47,GX),fr(.45,GY),d,T.shelf.id);
      fillBox(fr(.53,GX),fr(.25,GY),0,GX-1,fr(.45,GY),d,T.open.id);
      fillBox(0,0,0,GX-1,fr(.2,GY),d,T.shelf.id)}},
    {name:'–õ–µ—Å–µ–Ω–∫–∞',fill:()=>{const d=Math.min(3,GZ-1);const cols=4;
      for(let c=0;c<cols;c++){
        const x1=fr(c/cols,GX),x2=fr((c+1)/cols,GX)-1;
        const rows=cols-c+1;
        for(let r=0;r<rows;r++){const y1=fr(r/rows,GY),y2=fr((r+1)/rows,GY)-1;
          fillBox(x1,y1,0,x2,y2,d,r%2===0?T.shelf.id:T.open.id)}}}},
    {name:'–ö–Ω–∏–∂–Ω–∞—è —Å—Ç–µ–Ω–∫–∞',fill:()=>{const d=Math.min(3,GZ-1);
      fillBox(0,fr(.8,GY),0,GX-1,GY-1,d,T.books.id);
      fillBox(0,fr(.6,GY),0,fr(.47,GX),fr(.75,GY),d,T.shelf.id);
      fillBox(fr(.53,GX),fr(.6,GY),0,GX-1,fr(.75,GY),d,T.books.id);
      fillBox(0,fr(.4,GY),0,GX-1,fr(.55,GY),d,T.books.id);
      fillBox(0,fr(.2,GY),0,fr(.47,GX),fr(.35,GY),d,T.open.id);
      fillBox(fr(.53,GX),fr(.2,GY),0,GX-1,fr(.35,GY),d,T.shelf.id);
      fillBox(0,0,0,GX-1,fr(.15,GY),d,T.drawer.id)}},
  ],
  kitchen:[
    {name:'–õ–∏–Ω–µ–π–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.58,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,0,0,fr(.25,GX),fr(.3,GY),d,T.sink.id);
      fillBox(fr(.28,GX),0,0,fr(.47,GX),fr(.3,GY),d,T.drawer.id);
      fillBox(fr(.5,GX),fr(.17,GY),0,fr(.73,GX),fr(.3,GY),d,T.cooktop.id);
      fillBox(fr(.5,GX),0,0,fr(.73,GX),fr(.14,GY),d,T.oven.id);
      fillBox(fr(.76,GX),0,0,GX-1,fr(.3,GY),d,T.dishw.id)}},
    {name:'–£–≥–ª–æ–≤–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const ld=Math.min(10,GZ-1);
      fillBox(0,fr(.58,GY),0,GX-1,GY-1,d,T.shelf.id);fillBox(0,fr(.58,GY),0,fr(.15,GX),GY-1,ld,T.shelf.id);
      fillBox(0,0,0,fr(.25,GX),fr(.3,GY),d,T.sink.id);
      fillBox(fr(.28,GX),0,0,fr(.47,GX),fr(.3,GY),d,T.drawer.id);
      fillBox(fr(.5,GX),fr(.17,GY),0,fr(.73,GX),fr(.3,GY),d,T.cooktop.id);
      fillBox(fr(.5,GX),0,0,fr(.73,GX),fr(.14,GY),d,T.oven.id);
      fillBox(fr(.76,GX),0,0,GX-1,fr(.3,GY),d,T.drawer.id);
      fillBox(0,0,0,fr(.15,GX),fr(.3,GY),ld,T.drawer.id)}},
    {name:'–° –æ—Å—Ç—Ä–æ–≤–æ–º',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,fr(.58,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,0,0,fr(.25,GX),fr(.3,GY),d,T.sink.id);
      fillBox(fr(.28,GX),0,0,fr(.47,GX),fr(.3,GY),d,T.drawer.id);
      fillBox(fr(.5,GX),fr(.17,GY),0,fr(.73,GX),fr(.3,GY),d,T.cooktop.id);
      fillBox(fr(.5,GX),0,0,fr(.73,GX),fr(.14,GY),d,T.oven.id);
      fillBox(fr(.76,GX),0,0,GX-1,fr(.3,GY),d,T.dishw.id);
      fillBox(fr(.28,GX),0,Math.round(GZ*.4),fr(.72,GX),fr(.3,GY),Math.round(GZ*.55),T.drawer.id)}},
    {name:'–ü-–æ–±—Ä–∞–∑–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const ld=Math.min(10,GZ-1);
      fillBox(0,fr(.58,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,fr(.58,GY),0,fr(.15,GX),GY-1,ld,T.shelf.id);
      fillBox(fr(.85,GX),fr(.58,GY),0,GX-1,GY-1,ld,T.shelf.id);
      fillBox(0,0,0,fr(.25,GX),fr(.3,GY),d,T.sink.id);
      fillBox(fr(.28,GX),0,0,fr(.47,GX),fr(.3,GY),d,T.drawer.id);
      fillBox(fr(.5,GX),fr(.17,GY),0,fr(.73,GX),fr(.3,GY),d,T.cooktop.id);
      fillBox(fr(.5,GX),0,0,fr(.73,GX),fr(.14,GY),d,T.oven.id);
      fillBox(fr(.76,GX),0,0,GX-1,fr(.3,GY),d,T.dishw.id);
      fillBox(0,0,0,fr(.15,GX),fr(.3,GY),ld,T.drawer.id);
      fillBox(fr(.85,GX),0,0,GX-1,fr(.3,GY),ld,T.shelf.id)}},
    {name:'–ë–µ–∑ –≤–µ—Ä—Ö–∞',fill:()=>{const d=Math.min(5,GZ-1);
      fillBox(0,0,0,fr(.25,GX),fr(.4,GY),d,T.sink.id);
      fillBox(fr(.28,GX),0,0,fr(.47,GX),fr(.4,GY),d,T.drawer.id);
      fillBox(fr(.5,GX),fr(.22,GY),0,fr(.73,GX),fr(.4,GY),d,T.cooktop.id);
      fillBox(fr(.5,GX),0,0,fr(.73,GX),fr(.19,GY),d,T.oven.id);
      fillBox(fr(.76,GX),0,0,GX-1,fr(.4,GY),d,T.dishw.id)}},
    {name:'–î–≤—É—Ö—Ä—è–¥–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const bd=Math.min(5,GZ-1);const offZ=Math.max(Math.round(GZ*.6),bd+1);const offZe=Math.min(offZ+bd,GZ-1);
      fillBox(0,fr(.58,GY),0,GX-1,GY-1,d,T.shelf.id);
      fillBox(0,0,0,fr(.25,GX),fr(.3,GY),d,T.sink.id);
      fillBox(fr(.28,GX),0,0,fr(.55,GX),fr(.3,GY),d,T.drawer.id);
      fillBox(fr(.58,GX),fr(.17,GY),0,fr(.78,GX),fr(.3,GY),d,T.cooktop.id);
      fillBox(fr(.58,GX),0,0,fr(.78,GX),fr(.14,GY),d,T.oven.id);
      fillBox(fr(.81,GX),0,0,GX-1,fr(.3,GY),d,T.dishw.id);
      fillBox(fr(.2,GX),0,offZ,fr(.8,GX),fr(.3,GY),offZe,T.drawer.id);
      fillBox(fr(.2,GX),fr(.58,GY),offZ,fr(.8,GX),GY-1,offZe,T.shelf.id)}},
  ],
  closet:[
    {name:'–ì-–æ–±—Ä–∞–∑–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const ld=GZ-1;const sd=Math.min(5,GZ-1);
      /* –∑–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∞ ‚Äî –≤—Å—è —à–∏—Ä–∏–Ω–∞ */
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.45,GY),0,fr(.32,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.36,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.36,GX),fr(.3,GY),0,fr(.65,GX),fr(.5,GY),d,T.drawer.id);
      fillBox(fr(.7,GX),fr(.3,GY),0,GX-1,fr(.5,GY),d,T.drawer.id);
      fillBox(0,0,0,fr(.32,GX),fr(.4,GY),d,T.shoeLow.id);
      fillBox(fr(.36,GX),0,0,GX-1,fr(.25,GY),d,T.shelf.id);
      /* –ª–µ–≤–∞—è —Å—Ç–µ–Ω–∞ ‚Äî –ø–æ –≥–ª—É–±–∏–Ω–µ */
      fillBox(0,fr(.9,GY),d+1,fr(.15,GX),GY-1,ld,T.top.id);
      fillBox(0,fr(.35,GY),d+1,fr(.15,GX),fr(.85,GY),ld,T.hanging.id);
      fillBox(0,0,d+1,fr(.15,GX),fr(.3,GY),ld,T.shelf.id)}},
    {name:'–ü-–æ–±—Ä–∞–∑–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const ld=GZ-1;
      /* –∑–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∞ */
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.4,GY),0,fr(.47,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.53,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.53,GX),fr(.35,GY),0,GX-1,fr(.5,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.35,GY),d,T.shelf.id);
      /* –ª–µ–≤–∞—è —Å—Ç–µ–Ω–∞ */
      fillBox(0,fr(.9,GY),d+1,fr(.15,GX),GY-1,ld,T.top.id);
      fillBox(0,fr(.4,GY),d+1,fr(.15,GX),fr(.85,GY),ld,T.shelf.id);
      fillBox(0,fr(.15,GY),d+1,fr(.15,GX),fr(.35,GY),ld,T.drawer.id);
      fillBox(0,0,d+1,fr(.15,GX),fr(.1,GY),ld,T.shoeLow.id);
      /* –ø—Ä–∞–≤–∞—è —Å—Ç–µ–Ω–∞ */
      fillBox(fr(.85,GX),fr(.9,GY),d+1,GX-1,GY-1,ld,T.top.id);
      fillBox(fr(.85,GX),fr(.4,GY),d+1,GX-1,fr(.85,GY),ld,T.hanging.id);
      fillBox(fr(.85,GX),0,d+1,GX-1,fr(.35,GY),ld,T.shoeHi.id)}},
    {name:'–õ–∏–Ω–µ–π–Ω–∞—è',fill:()=>{const d=Math.min(6,GZ-1);
      /* –æ–¥–Ω–∞ —Å—Ç–µ–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ—Ä–Ω–µ–µ */
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.45,GY),0,fr(.24,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.27,GX),fr(.55,GY),0,fr(.52,GX),fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.27,GX),fr(.3,GY),0,fr(.52,GX),fr(.5,GY),d,T.drawer.id);
      fillBox(fr(.55,GX),fr(.45,GY),0,fr(.75,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.55,GX),fr(.15,GY),0,fr(.75,GX),fr(.4,GY),d,T.open.id);
      fillBox(fr(.78,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.78,GX),fr(.3,GY),0,GX-1,fr(.5,GY),d,T.drawer.id);
      fillBox(0,0,0,fr(.24,GX),fr(.4,GY),d,T.shoeHi.id);
      fillBox(fr(.78,GX),0,0,GX-1,fr(.25,GY),d,T.shoeLow.id);
      fillBox(fr(.27,GX),0,0,fr(.75,GX),fr(.25,GY),d,T.shelf.id)}},
    {name:'–î–≤–µ —Å—Ç–µ–Ω—ã',fill:()=>{const d=Math.min(5,GZ-1);const bz=Math.max(Math.round(GZ*.7),d+2);const be=GZ-1;
      /* –∑–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∞ */
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.35,GY),0,fr(.47,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.53,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.53,GX),fr(.3,GY),0,GX-1,fr(.5,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.3,GY),d,T.shelf.id);
      /* –ø–µ—Ä–µ–¥–Ω—è—è —Å—Ç–µ–Ω–∞ (–¥–∞–ª—å–Ω—è—è –ø–æ Z) */
      fillBox(0,fr(.9,GY),bz,GX-1,GY-1,be,T.top.id);
      fillBox(0,fr(.35,GY),bz,fr(.47,GX),fr(.85,GY),be,T.hanging.id);
      fillBox(fr(.53,GX),fr(.35,GY),bz,GX-1,fr(.85,GY),be,T.shelf.id);
      fillBox(0,fr(.1,GY),bz,fr(.47,GX),fr(.3,GY),be,T.drawer.id);
      fillBox(fr(.53,GX),0,bz,GX-1,fr(.3,GY),be,T.shoeLow.id);
      fillBox(0,0,bz,fr(.47,GX),fr(.08,GY),be,T.shelf.id)}},
    {name:'–° –æ—Å—Ç—Ä–æ–≤–æ–º',fill:()=>{const d=Math.min(5,GZ-1);const ld=GZ-1;const iZ1=Math.round(GZ*.35);const iZ2=Math.round(GZ*.6);
      /* –∑–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∞ */
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.35,GY),0,GX-1,fr(.85,GY),d,T.hanging.id);
      fillBox(0,0,0,GX-1,fr(.3,GY),d,T.shelf.id);
      /* –±–æ–∫–æ–≤—ã–µ —Å—Ç–µ–Ω—ã */
      fillBox(0,fr(.5,GY),d+1,fr(.12,GX),fr(.85,GY),ld,T.shelf.id);
      fillBox(0,0,d+1,fr(.12,GX),fr(.45,GY),ld,T.drawer.id);
      fillBox(fr(.88,GX),fr(.5,GY),d+1,GX-1,fr(.85,GY),ld,T.shelf.id);
      fillBox(fr(.88,GX),0,d+1,GX-1,fr(.45,GY),ld,T.shoeLow.id);
      /* –æ—Å—Ç—Ä–æ–≤ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      fillBox(fr(.3,GX),0,iZ1,fr(.7,GX),fr(.4,GY),iZ2,T.drawer.id);
      fillBox(fr(.3,GX),fr(.45,GY),iZ1,fr(.7,GX),fr(.5,GY),iZ2,T.shelf.id)}},
    {name:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è',fill:()=>{const d=Math.min(5,GZ-1);const ld=GZ-1;const bz=Math.max(Math.round(GZ*.75),d+2);const be=GZ-1;
      /* –∑–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∞  */
      fillBox(0,fr(.9,GY),0,GX-1,GY-1,d,T.top.id);
      fillBox(0,fr(.5,GY),0,fr(.24,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.27,GX),fr(.55,GY),0,fr(.52,GX),fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.27,GX),fr(.3,GY),0,fr(.52,GX),fr(.5,GY),d,T.drawer.id);
      fillBox(fr(.55,GX),fr(.5,GY),0,fr(.75,GX),fr(.85,GY),d,T.hanging.id);
      fillBox(fr(.78,GX),fr(.55,GY),0,GX-1,fr(.85,GY),d,T.shelf.id);
      fillBox(fr(.78,GX),fr(.3,GY),0,GX-1,fr(.5,GY),d,T.drawer.id);
      fillBox(0,0,0,GX-1,fr(.25,GY),d,T.shelf.id);
      /* –ª–µ–≤–∞—è —Å—Ç–µ–Ω–∞ */
      fillBox(0,fr(.9,GY),d+1,fr(.12,GX),GY-1,ld,T.top.id);
      fillBox(0,fr(.4,GY),d+1,fr(.12,GX),fr(.85,GY),ld,T.shelf.id);
      fillBox(0,fr(.15,GY),d+1,fr(.12,GX),fr(.35,GY),ld,T.drawer.id);
      fillBox(0,0,d+1,fr(.12,GX),fr(.1,GY),ld,T.shoeLow.id);
      /* –ø—Ä–∞–≤–∞—è —Å—Ç–µ–Ω–∞ */
      fillBox(fr(.88,GX),fr(.9,GY),d+1,GX-1,GY-1,ld,T.top.id);
      fillBox(fr(.88,GX),fr(.4,GY),d+1,GX-1,fr(.85,GY),ld,T.hanging.id);
      fillBox(fr(.88,GX),fr(.15,GY),d+1,GX-1,fr(.35,GY),ld,T.shoeHi.id);
      fillBox(fr(.88,GX),0,d+1,GX-1,fr(.1,GY),ld,T.shelf.id);
      /* –ø–µ—Ä–µ–¥–Ω—è—è —Å—Ç–µ–Ω–∞ */
      fillBox(fr(.2,GX),fr(.9,GY),bz,fr(.8,GX),GY-1,be,T.top.id);
      fillBox(fr(.2,GX),fr(.35,GY),bz,fr(.5,GX),fr(.85,GY),be,T.open.id);
      fillBox(fr(.55,GX),fr(.35,GY),bz,fr(.8,GX),fr(.85,GY),be,T.shelf.id);
      fillBox(fr(.2,GX),0,bz,fr(.8,GX),fr(.3,GY),be,T.drawer.id)}},
  ],
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  UNDO  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const undoStack=[];const MAX_UNDO=50;
function pushUndo(){undoStack.push({gx:GX,gy:GY,gz:GZ,data:new Uint8Array(voxels)});if(undoStack.length>MAX_UNDO)undoStack.shift()}
function doUndo(){if(!undoStack.length)return;const s=undoStack.pop();
  GX=s.gx;GY=s.gy;GZ=s.gz;voxels=s.data;fullRebuild()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  STATE  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentBrush=TYPES.shelf.id,currentTool='cursor',currentCat='wardrobe',activePresetIdx=0;
let splitH=true,splitW=true,splitD=true;
let frontOverride='auto'; /* 'auto','nz','pz','nx','px' */
let selectedReg=null; /* {typeId, minX,maxX,minY,maxY,minZ,maxZ} */
let handleDrag=null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  DOM  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $=id=>document.getElementById(id);
const palRow=$('pal-row'),eraserBtn=$('eraser-btn'),cursorBtn=$('cursor-btn'),presetRow=$('preset-row');
const roomWEl=$('roomW'),roomDEl=$('roomD'),dimHEl=$('dimH');
const shelfHEl=$('shelfH'),drawerHEl=$('drawerH'),shoeHEl=$('shoeH'),
  bootHEl=$('bootH'),bookHEl=$('bookH'),openHEl=$('openH');
const togH=$('tog-h'),togW=$('tog-w'),togD=$('tog-d');
const editorVP=$('editor-vp'),previewVP=$('preview-vp');
const selPanel=$('sel-panel'),selColor=$('sel-color'),selName=$('sel-name');
const selW=$('sel-w'),selH=$('sel-h'),selD=$('sel-d');
const canvas=()=>eRenderer.domElement;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  PALETTE  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildPalette(){
  palRow.innerHTML='';
  CAT_TYPES[currentCat].forEach(k=>{const t=TYPES[k];
    const b=document.createElement('button');b.className='pal-btn';b.dataset.typeId=t.id;
    b.innerHTML=`<span class="sw" style="background:${t.color}"></span>${t.label}`;
    b.addEventListener('click',()=>{currentTool='brush';currentBrush=t.id;selectRegion(null);refreshPal()});
    palRow.appendChild(b)});
  if(!CAT_TYPES[currentCat].some(k=>TYPES[k].id===currentBrush)){
    currentBrush=TYPES[CAT_TYPES[currentCat][0]].id;currentTool='brush'}
  refreshPal()}
function refreshPal(){
  eraserBtn.classList.toggle('active',currentTool==='eraser');
  cursorBtn.classList.toggle('active',currentTool==='cursor');
  palRow.querySelectorAll('.pal-btn').forEach(b=>
    b.classList.toggle('active',+b.dataset.typeId===currentBrush&&currentTool==='brush'));
  const cv=eRenderer?.domElement;if(cv){cv.classList.toggle('brush-mode',currentTool==='brush');cv.classList.toggle('eraser-mode',currentTool==='eraser')}
  document.querySelectorAll('.subdiv-for').forEach(el=>
    el.style.display=el.dataset.for==String(currentBrush)?'':'none')}
eraserBtn.addEventListener('click',()=>{currentTool='eraser';selectRegion(null);refreshPal()});
cursorBtn.addEventListener('click',()=>{currentTool='cursor';refreshPal()});

function buildPresets(){
  presetRow.innerHTML='';
  (CATEGORY_PRESETS[currentCat]||[]).forEach((p,i)=>{
    const b=document.createElement('button');b.className='preset-btn'+(i===activePresetIdx?' active':'');
    b.textContent=p.name;
    b.addEventListener('click',()=>{activePresetIdx=i;
      presetRow.querySelectorAll('.preset-btn').forEach((bb,j)=>bb.classList.toggle('active',j===i));
      pushUndo();vClear();p.fill();fullRebuild()});
    presetRow.appendChild(b)})}

document.querySelectorAll('.cat-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelector('.cat-btn.active').classList.remove('active');b.classList.add('active');
  currentCat=b.dataset.cat;activePresetIdx=0;
  pushUndo();vClear();const p=CATEGORY_PRESETS[currentCat]?.[0];if(p)p.fill();
  buildPalette();buildPresets();fullRebuild()}));

togH.addEventListener('click',()=>{splitH=!splitH;togH.classList.toggle('on',splitH);scheduleRebuild()});
togW.addEventListener('click',()=>{splitW=!splitW;togW.classList.toggle('on',splitW);scheduleRebuild()});
togD.addEventListener('click',()=>{splitD=!splitD;togD.classList.toggle('on',splitD);scheduleRebuild()});
/* front override buttons */
document.querySelectorAll('[data-front]').forEach(b=>b.addEventListener('click',()=>{
  frontOverride=b.dataset.front;
  document.querySelectorAll('[data-front]').forEach(bb=>{bb.classList.toggle('on',bb.dataset.front===frontOverride);bb.querySelector('.indicator').style.background=bb.dataset.front===frontOverride?'#000':'#fff'});
  scheduleRebuild();
}));
[shelfHEl,drawerHEl,shoeHEl,bootHEl,bookHEl,openHEl].forEach(el=>el.addEventListener('input',()=>scheduleRebuild()));
/* dim change ‚Üí resize grid */
[roomWEl,roomDEl,dimHEl].forEach(el=>el.addEventListener('input',()=>{
  pushUndo();recomputeGrid();fullRebuild()}));
$('btn-undo').addEventListener('click',doUndo);
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();doUndo()}});
$('btn-clear').addEventListener('click',()=>{pushUndo();vClear();fullRebuild()});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  HELPERS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getDims(){
  return{rw:GX*CELL,rd:GZ*CELL,h:GY*CELL,cw:CELL,ch:CELL,cd:CELL}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  SHARED MATERIALS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const _matC={};
function getColorMat(hex){if(_matC[hex])return _matC[hex];
  const m=new THREE.MeshBasicMaterial({color:new THREE.Color(hex),transparent:true,opacity:.45,
    side:THREE.DoubleSide,depthWrite:true,polygonOffset:true,polygonOffsetFactor:2,polygonOffsetUnits:2});
  _matC[hex]=m;return m}
const TM=new THREE.LineBasicMaterial({color:0x000000,linewidth:1,depthTest:true});
const LM=new THREE.LineBasicMaterial({color:0x000000,linewidth:2,depthTest:true});
const RM=new THREE.LineBasicMaterial({color:0xdddddd,linewidth:1});
const unitBox=new THREE.BoxGeometry(1,1,1);
const unitEdges=new THREE.EdgesGeometry(unitBox);
/* invisible material for raycasting hit targets */
const hitMat=new THREE.MeshBasicMaterial({transparent:true,opacity:0,depthWrite:false});

function v2w(x,y,z){const{rw,rd}=getDims();
  return new THREE.Vector3((x+.5)*CELL-rw/2,(y+.5)*CELL,(z+.5)*CELL-rd/2)}
function wb(parent,w,h,d,x,y,z,mat){mat=mat||TM;
  const g=new THREE.BoxGeometry(w,h,d),e=new THREE.EdgesGeometry(g),s=new THREE.LineSegments(e,mat);
  s.renderOrder=1;s.position.set(x,y,z);parent.add(s);return s}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EDITOR VIEWPORT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const eScene=new THREE.Scene();eScene.background=new THREE.Color(0xf3f4f6);
let eFrust=12;
const eAspect=()=>editorVP.clientWidth/(editorVP.clientHeight||1);
const eCam=new THREE.OrthographicCamera(-eFrust*eAspect()/2,eFrust*eAspect()/2,eFrust/2,-eFrust/2,.1,1000);
eCam.position.set(10,10,10);eCam.lookAt(0,0,0);
const eRenderer=new THREE.WebGLRenderer({antialias:true});
eRenderer.setPixelRatio(window.devicePixelRatio);
eRenderer.setSize(editorVP.clientWidth,editorVP.clientHeight);
editorVP.appendChild(eRenderer.domElement);
const eControls=new OrbitControls(eCam,eRenderer.domElement);
eControls.enableDamping=true;eControls.dampingFactor=.12;

const eFloor=new THREE.Group();eScene.add(eFloor);
const eHitG=new THREE.Group();eScene.add(eHitG);   /* invisible hit meshes for raycasting */
const eBlockG=new THREE.Group();eScene.add(eBlockG); /* merged visual blocks */
const eBounds=new THREE.Group();eScene.add(eBounds);

/* selection highlight */
const selHighlightMat=new THREE.LineBasicMaterial({color:0xff6600,linewidth:3});
const selHighlightMesh=new THREE.LineSegments(new THREE.EdgesGeometry(unitBox),selHighlightMat);
selHighlightMesh.visible=false;eScene.add(selHighlightMesh);
/* preview highlight added after pScene creation */
let selHighlightP=null;

/* ‚îÄ‚îÄ resize handles (6 face handles) ‚îÄ‚îÄ */
const HANDLE_THICK=0.025;
const handleMat=new THREE.MeshBasicMaterial({color:0xff6600,transparent:true,opacity:.85,depthWrite:false});
const handleGeo=new THREE.BoxGeometry(1,1,1);
const handleG=new THREE.Group();eScene.add(handleG);
const handles=[];
for(const[axis,dir]of[['x',1],['x',-1],['y',1],['y',-1],['z',1],['z',-1]]){
  const m=new THREE.Mesh(handleGeo,handleMat.clone());m.visible=false;
  m.userData={isHandle:true,axis,dir};
  const w=new THREE.LineSegments(new THREE.EdgesGeometry(handleGeo),new THREE.LineBasicMaterial({color:0x000000}));
  m.add(w);handleG.add(m);handles.push({mesh:m,axis,dir})}

function positionHandles(){
  if(!selectedReg||currentTool!=='cursor'){handles.forEach(h=>h.mesh.visible=false);return}
  const r=selectedReg,{rw,rd}=getDims();
  const bx1=r.minX*CELL-rw/2,bx2=(r.maxX+1)*CELL-rw/2;
  const by1=r.minY*CELL,by2=(r.maxY+1)*CELL;
  const bz1=r.minZ*CELL-rd/2,bz2=(r.maxZ+1)*CELL-rd/2;
  const bcx=(bx1+bx2)/2,bcy=(by1+by2)/2,bcz=(bz1+bz2)/2;
  const bW=bx2-bx1,bH=by2-by1,bD=bz2-bz1;
  const hs=HANDLE_THICK;
  for(const h of handles){
    h.mesh.visible=true;
    if(h.axis==='x'&&h.dir===1){h.mesh.position.set(bx2+hs/2,bcy,bcz);h.mesh.scale.set(hs,Math.max(hs,bH*.35),Math.max(hs,bD*.35))}
    else if(h.axis==='x'&&h.dir===-1){h.mesh.position.set(bx1-hs/2,bcy,bcz);h.mesh.scale.set(hs,Math.max(hs,bH*.35),Math.max(hs,bD*.35))}
    else if(h.axis==='y'&&h.dir===1){h.mesh.position.set(bcx,by2+hs/2,bcz);h.mesh.scale.set(Math.max(hs,bW*.35),hs,Math.max(hs,bD*.35))}
    else if(h.axis==='y'&&h.dir===-1){h.mesh.position.set(bcx,by1-hs/2,bcz);h.mesh.scale.set(Math.max(hs,bW*.35),hs,Math.max(hs,bD*.35))}
    else if(h.axis==='z'&&h.dir===1){h.mesh.position.set(bcx,bcy,bz2+hs/2);h.mesh.scale.set(Math.max(hs,bW*.35),Math.max(hs,bH*.35),hs)}
    else{h.mesh.position.set(bcx,bcy,bz1-hs/2);h.mesh.scale.set(Math.max(hs,bW*.35),Math.max(hs,bH*.35),hs)}
  }
}

/* ‚îÄ‚îÄ handle drag logic ‚îÄ‚îÄ */
function updateHandleDrag(e){
  if(!handleDrag)return;
  const rect=eRenderer.domElement.getBoundingClientRect();
  mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,eCam);
  const camDir=new THREE.Vector3();eCam.getWorldDirection(camDir);
  const plane=new THREE.Plane().setFromNormalAndCoplanarPoint(camDir,handleDrag.startWorld);
  const inter=new THREE.Vector3();
  if(!raycaster.ray.intersectPlane(plane,inter))return;
  const delta=inter.sub(handleDrag.startWorld);
  const h=handleDrag.handle;
  let axisDelta=h.axis==='x'?delta.x:h.axis==='y'?delta.y:delta.z;
  const cellDelta=Math.round(axisDelta/CELL);
  let newMinX=handleDrag.startMin.x,newMaxX=handleDrag.startMax.x;
  let newMinY=handleDrag.startMin.y,newMaxY=handleDrag.startMax.y;
  let newMinZ=handleDrag.startMin.z,newMaxZ=handleDrag.startMax.z;
  if(h.axis==='x'&&h.dir===1) newMaxX=Math.max(newMinX,Math.min(GX-1,handleDrag.startMax.x+cellDelta));
  if(h.axis==='x'&&h.dir===-1) newMinX=Math.min(newMaxX,Math.max(0,handleDrag.startMin.x+cellDelta));
  if(h.axis==='y'&&h.dir===1) newMaxY=Math.max(newMinY,Math.min(GY-1,handleDrag.startMax.y+cellDelta));
  if(h.axis==='y'&&h.dir===-1) newMinY=Math.min(newMaxY,Math.max(0,handleDrag.startMin.y+cellDelta));
  if(h.axis==='z'&&h.dir===1) newMaxZ=Math.max(newMinZ,Math.min(GZ-1,handleDrag.startMax.z+cellDelta));
  if(h.axis==='z'&&h.dir===-1) newMinZ=Math.min(newMaxZ,Math.max(0,handleDrag.startMin.z+cellDelta));
  const{rw,rd}=getDims();
  const sx=(newMaxX-newMinX+1)*CELL,sy=(newMaxY-newMinY+1)*CELL,sz=(newMaxZ-newMinZ+1)*CELL;
  const cx=(newMinX+newMaxX+1)/2*CELL-rw/2,cy=(newMinY+newMaxY+1)/2*CELL,cz=(newMinZ+newMaxZ+1)/2*CELL-rd/2;
  stretchMesh.position.set(cx,cy,cz);stretchMesh.scale.set(sx,sy,sz);stretchMesh.visible=true;
  stretchWire.position.set(cx,cy,cz);stretchWire.scale.set(sx,sy,sz);stretchWire.visible=true;
  const w=(newMaxX-newMinX+1)*10,hh=(newMaxY-newMinY+1)*10,dd=(newMaxZ-newMinZ+1)*10;
  dragHint.textContent=`${w}√ó${hh}√ó${dd} —Å–º`;dragHint.style.display='block';
  handleDrag.newBox={x1:newMinX,y1:newMinY,z1:newMinZ,x2:newMaxX,y2:newMaxY,z2:newMaxZ};
}
function commitHandleDrag(){
  if(!handleDrag){cancelHandleDrag();return}
  if(!handleDrag.newBox){cancelHandleDrag();return}
  const r=handleDrag.origReg,nb=handleDrag.newBox;pushUndo();
  for(const[cx,cy,cz]of r.cells)vSet(cx,cy,cz,0);
  fillBox(nb.x1,nb.y1,nb.z1,nb.x2,nb.y2,nb.z2,r.typeId);
  const newReg=findRegionAt(nb.x1,nb.y1,nb.z1);selectRegion(newReg);
  rebuildEditorMeshes();rebuildPreview();updateInfo();cancelHandleDrag()}
function cancelHandleDrag(){handleDrag=null;stretchMesh.visible=false;stretchWire.visible=false;dragHint.style.display='none';eControls.enabled=true}

/* ghost */
const ghostPlaceMat=new THREE.MeshBasicMaterial({color:0x666666,transparent:true,opacity:.2,depthWrite:false});
const ghostEraseMat=new THREE.MeshBasicMaterial({color:0xff4444,transparent:true,opacity:.3,depthWrite:false});
const ghost=new THREE.Mesh(unitBox.clone(),ghostPlaceMat);ghost.visible=false;eScene.add(ghost);
const ghostEdge=new THREE.LineSegments(new THREE.EdgesGeometry(unitBox),
  new THREE.LineBasicMaterial({color:0x000000,transparent:true,opacity:.5}));ghostEdge.visible=false;eScene.add(ghostEdge);
let ghostVoxel=null;

/* ‚îÄ‚îÄ hit mesh management ‚îÄ‚îÄ */
const voxHitMap={};
function addHitMesh(x,y,z){
  const key=`${x},${y},${z}`;removeHitMesh(x,y,z);
  const pos=v2w(x,y,z);
  const mesh=new THREE.Mesh(unitBox,hitMat);
  mesh.position.copy(pos);mesh.scale.set(CELL,CELL,CELL);
  mesh.userData={vx:x,vy:y,vz:z};eHitG.add(mesh);
  voxHitMap[key]=mesh}
function removeHitMesh(x,y,z){
  const key=`${x},${y},${z}`,e=voxHitMap[key];if(!e)return;
  eHitG.remove(e);delete voxHitMap[key]}
function getHitMeshes(){return Object.values(voxHitMap)}

/* ‚îÄ‚îÄ rebuild hit meshes + merged blocks ‚îÄ‚îÄ */
function rebuildEditorMeshes(){
  /* clear hits */
  for(const m of Object.values(voxHitMap))eHitG.remove(m);
  for(const k in voxHitMap)delete voxHitMap[k];
  /* add invisible hit meshes */
  for(let z=0;z<GZ;z++)for(let y=0;y<GY;y++)for(let x=0;x<GX;x++){
    if(vGet(x,y,z))addHitMesh(x,y,z)}
  /* clear visual blocks */
  eBlockG.clear();
  /* draw merged blocks using regions */
  const{rw,rd}=getDims();
  const regs=findRegions3D();
  for(const reg of regs){
    const info=TYPE_BY_ID[reg.typeId];if(!info)continue;
    const bx1=reg.minX*CELL-rw/2,bx2=(reg.maxX+1)*CELL-rw/2;
    const by1=reg.minY*CELL,by2=(reg.maxY+1)*CELL;
    const bz1=reg.minZ*CELL-rd/2,bz2=(reg.maxZ+1)*CELL-rd/2;
    const bW=bx2-bx1-GAP,bH=by2-by1-GAP,bD=bz2-bz1-GAP;
    const bcx=(bx1+bx2)/2,bcy=(by1+by2)/2,bcz=(bz1+bz2)/2;
    const bm=new THREE.Mesh(new THREE.BoxGeometry(bW,bH,bD),getColorMat(info.color));
    bm.renderOrder=0;bm.position.set(bcx,bcy,bcz);
    bm.userData._reg=reg;
    eBlockG.add(bm);
    const bw=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(bW,bH,bD)),TM);
    bw.renderOrder=1;bw.position.set(bcx,bcy,bcz);eBlockG.add(bw);
  }
  updateSelHighlight();
}

function buildEditorFloor(){
  eFloor.clear();eBounds.clear();
  const{rw,rd,h}=getDims();
  const pts=[];
  for(let i=0;i<=GX;i++){const x=i*CELL-rw/2;pts.push(new THREE.Vector3(x,0,-rd/2),new THREE.Vector3(x,0,rd/2))}
  for(let j=0;j<=GZ;j++){const z=j*CELL-rd/2;pts.push(new THREE.Vector3(-rw/2,0,z),new THREE.Vector3(rw/2,0,z))}
  eFloor.add(new THREE.LineSegments(new THREE.BufferGeometry().setFromPoints(pts),RM));
  const be=new THREE.EdgesGeometry(new THREE.BoxGeometry(rw,h,rd));
  const bs=new THREE.LineSegments(be,new THREE.LineBasicMaterial({color:0xaaaaaa}));
  bs.position.set(0,h/2,0);eFloor.add(bs);
  const im=new THREE.MeshBasicMaterial({visible:false,side:THREE.DoubleSide});
  const fp=new THREE.Mesh(new THREE.PlaneGeometry(rw,rd),im.clone());fp.rotation.x=-Math.PI/2;fp.position.y=-0.001;fp.userData={face:'floor'};eBounds.add(fp);
  const bw=new THREE.Mesh(new THREE.PlaneGeometry(rw,h),im.clone());bw.position.set(0,h/2,-rd/2-.001);bw.userData={face:'back'};eBounds.add(bw);
  const fw=new THREE.Mesh(new THREE.PlaneGeometry(rw,h),im.clone());fw.rotation.y=Math.PI;fw.position.set(0,h/2,rd/2+.001);fw.userData={face:'front'};eBounds.add(fw);
  const lw=new THREE.Mesh(new THREE.PlaneGeometry(rd,h),im.clone());lw.rotation.y=Math.PI/2;lw.position.set(-rw/2-.001,h/2,0);lw.userData={face:'left'};eBounds.add(lw);
  const rww=new THREE.Mesh(new THREE.PlaneGeometry(rd,h),im.clone());rww.rotation.y=-Math.PI/2;rww.position.set(rw/2+.001,h/2,0);rww.userData={face:'right'};eBounds.add(rww)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  POINTER + DRAG  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const raycaster=new THREE.Raycaster();const mouse=new THREE.Vector2();
let pointerDownPos=null;

/* stretch ghost */
const stretchMat=new THREE.MeshBasicMaterial({color:0x4488ff,transparent:true,opacity:.18,depthWrite:false,side:THREE.DoubleSide});
const stretchWireMat=new THREE.LineBasicMaterial({color:0x2266cc,transparent:true,opacity:.7});
const stretchMesh=new THREE.Mesh(unitBox.clone(),stretchMat);stretchMesh.visible=false;eScene.add(stretchMesh);
const stretchWire=new THREE.LineSegments(new THREE.EdgesGeometry(unitBox),stretchWireMat);stretchWire.visible=false;eScene.add(stretchWire);
const dragHint=$('drag-hint');
let drag=null;

function hitToVoxel(e){
  const rect=eRenderer.domElement.getBoundingClientRect();
  mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,eCam);
  const{rw,rd,h}=getDims();
  const voxHits=raycaster.intersectObjects(getHitMeshes(),false);
  const boundHits=raycaster.intersectObjects(eBounds.children,false);
  const allHits=[...voxHits.map(h=>({hit:h,src:'vox'})),...boundHits.map(h=>({hit:h,src:'bound'}))];
  allHits.sort((a,b)=>a.hit.distance-b.hit.distance);
  for(const{hit,src}of allHits){
    let gx,gy,gz,nAxis,nDir;
    if(src==='vox'){
      const n=hit.face.normal;
      gx=hit.object.userData.vx+Math.round(n.x);gy=hit.object.userData.vy+Math.round(n.y);gz=hit.object.userData.vz+Math.round(n.z);
      if(Math.abs(n.x)>.5){nAxis='x';nDir=Math.sign(n.x)}else if(Math.abs(n.y)>.5){nAxis='y';nDir=Math.sign(n.y)}else{nAxis='z';nDir=Math.sign(n.z)}
    }else{
      const f=hit.object.userData.face,p=hit.point;
      if(f==='floor'){gx=Math.floor((p.x+rw/2)/CELL);gy=0;gz=Math.floor((p.z+rd/2)/CELL);nAxis='y';nDir=-1}
      else if(f==='back'){gx=Math.floor((p.x+rw/2)/CELL);gy=Math.floor(p.y/CELL);gz=0;nAxis='z';nDir=-1}
      else if(f==='front'){gx=Math.floor((p.x+rw/2)/CELL);gy=Math.floor(p.y/CELL);gz=GZ-1;nAxis='z';nDir=1}
      else if(f==='left'){gx=0;gy=Math.floor(p.y/CELL);gz=Math.floor((p.z+rd/2)/CELL);nAxis='x';nDir=-1}
      else{gx=GX-1;gy=Math.floor(p.y/CELL);gz=Math.floor((p.z+rd/2)/CELL);nAxis='x';nDir=1}}
    gx=Math.max(0,Math.min(GX-1,gx));gy=Math.max(0,Math.min(GY-1,gy));gz=Math.max(0,Math.min(GZ-1,gz));
    if(currentTool==='eraser'||!vGet(gx,gy,gz)) return{gx,gy,gz,nAxis,nDir};
  }
  return null;
}

function getDragBox(){
  if(!drag)return null;
  const d=drag.depth,na=drag.normalAxis,nd=drag.normalDir;
  let x1=Math.min(drag.sx,drag.curX),x2=Math.max(drag.sx,drag.curX);
  let y1=Math.min(drag.sy,drag.curY),y2=Math.max(drag.sy,drag.curY);
  let z1=Math.min(drag.sz,drag.curZ),z2=Math.max(drag.sz,drag.curZ);
  if(d!==0){if(na==='x'){if(nd>0)x2+=d;else x1-=d}
    else if(na==='y'){if(nd>0)y2+=d;else y1-=d}
    else{if(nd>0)z2+=d;else z1-=d}}
  x1=Math.max(0,x1);y1=Math.max(0,y1);z1=Math.max(0,z1);
  x2=Math.min(GX-1,x2);y2=Math.min(GY-1,y2);z2=Math.min(GZ-1,z2);
  return{x1,y1,z1,x2,y2,z2};
}
function updateStretchGhost(){
  const box=getDragBox();
  if(!box){stretchMesh.visible=false;stretchWire.visible=false;dragHint.style.display='none';return}
  const{rw,rd}=getDims();
  const sx=(box.x2-box.x1+1)*CELL,sy=(box.y2-box.y1+1)*CELL,sz=(box.z2-box.z1+1)*CELL;
  const cx=(box.x1+box.x2+1)/2*CELL-rw/2,cy=(box.y1+box.y2+1)/2*CELL,cz=(box.z1+box.z2+1)/2*CELL-rd/2;
  stretchMesh.position.set(cx,cy,cz);stretchMesh.scale.set(sx,sy,sz);stretchMesh.visible=true;
  stretchWire.position.set(cx,cy,cz);stretchWire.scale.set(sx,sy,sz);stretchWire.visible=true;
  const w=((box.x2-box.x1+1)*10),h2=((box.y2-box.y1+1)*10),dd=((box.z2-box.z1+1)*10);
  dragHint.textContent=`${w}√ó${h2}√ó${dd} —Å–º  (—Å–∫—Ä–æ–ª–ª = –≥–ª—É–±–∏–Ω–∞)`;dragHint.style.display='block';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  CURSOR HELPERS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function hitHandleAt(e){
  const rect=eRenderer.domElement.getBoundingClientRect();
  mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,eCam);
  const vis=handles.filter(h=>h.mesh.visible).map(h=>h.mesh);
  const hh=raycaster.intersectObjects(vis,false);
  if(!hh.length)return null;
  return handles.find(h=>h.mesh===hh[0].object)||null;
}
function hitBlockAt(e){
  const rect=eRenderer.domElement.getBoundingClientRect();
  mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
  mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,eCam);
  const hits=raycaster.intersectObjects(eBlockG.children.filter(ch=>ch.isMesh),false);
  if(!hits.length)return null;
  return hits[0].object.userData._reg||null;
}

function updateCursor(e){
  const c=eRenderer.domElement;
  if(handleDrag){c.style.cursor='grabbing';return}
  if(drag){c.style.cursor='move';return}
  if(currentTool==='cursor'){
    if(!e){c.style.cursor='default';return}
    if(selectedReg){const hh=hitHandleAt(e);
      if(hh){c.style.cursor=hh.axis==='y'?'ns-resize':'ew-resize';return}}
    c.style.cursor=hitBlockAt(e)?'pointer':'default';return}
  if(currentTool==='eraser'){
    if(!e){c.style.cursor='crosshair';return}
    c.style.cursor=hitBlockAt(e)?'pointer':'crosshair';return}
  c.style.cursor='crosshair';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  GHOST + EVENTS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateGhost(e){
  if(currentTool==='cursor'||handleDrag){ghost.visible=false;ghostEdge.visible=false;ghostVoxel=null;updateCursor(e);return}
  if(drag){const hv=hitToVoxel(e);
    if(hv){drag.curX=hv.gx;drag.curY=hv.gy;drag.curZ=hv.gz;updateStretchGhost()}
    ghost.visible=false;ghostEdge.visible=false;return}
  const hv=hitToVoxel(e);
  ghostVoxel=null;ghost.visible=false;ghostEdge.visible=false;
  if(!hv){updateCursor(e);return}
  if(currentTool==='eraser'){
    if(vGet(hv.gx,hv.gy,hv.gz)){ghostVoxel={x:hv.gx,y:hv.gy,z:hv.gz};
      const pos=v2w(hv.gx,hv.gy,hv.gz);ghost.position.copy(pos);ghost.scale.set(CELL,CELL,CELL);ghost.material=ghostEraseMat;ghost.visible=true;
      ghostEdge.position.copy(pos);ghostEdge.scale.set(CELL,CELL,CELL);ghostEdge.visible=true}
    updateCursor(e);return}
  if(!vGet(hv.gx,hv.gy,hv.gz)){ghostVoxel={x:hv.gx,y:hv.gy,z:hv.gz};
    const pos=v2w(hv.gx,hv.gy,hv.gz);ghost.position.copy(pos);ghost.scale.set(CELL,CELL,CELL);ghost.material=ghostPlaceMat;ghost.visible=true;
    ghostEdge.position.copy(pos);ghostEdge.scale.set(CELL,CELL,CELL);ghostEdge.visible=true}
  updateCursor(e);
}

eRenderer.domElement.addEventListener('pointermove',updateGhost);

eRenderer.domElement.addEventListener('pointerdown',e=>{
  if(e.button!==0)return;pointerDownPos={x:e.clientX,y:e.clientY};
  if(currentTool==='cursor'){
    if(selectedReg){const hh=hitHandleAt(e);if(hh){
      handleDrag={origReg:{...selectedReg,cells:selectedReg.cells.slice()},handle:hh,
        startWorld:hh.mesh.position.clone(),
        startMin:{x:selectedReg.minX,y:selectedReg.minY,z:selectedReg.minZ},
        startMax:{x:selectedReg.maxX,y:selectedReg.maxY,z:selectedReg.maxZ},newBox:null};
      const rect=eRenderer.domElement.getBoundingClientRect();
      mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
      mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
      raycaster.setFromCamera(mouse,eCam);
      const camDir=new THREE.Vector3();eCam.getWorldDirection(camDir);
      const pl=new THREE.Plane().setFromNormalAndCoplanarPoint(camDir,handleDrag.startWorld);
      const pt=new THREE.Vector3();
      if(raycaster.ray.intersectPlane(pl,pt))handleDrag.startWorld.copy(pt);
      eControls.enabled=false;eRenderer.domElement.style.cursor='grabbing';return}}
    return}
  if(currentTool==='brush'&&ghostVoxel){const hv=hitToVoxel(e);
    if(hv){drag={sx:hv.gx,sy:hv.gy,sz:hv.gz,normalAxis:hv.nAxis,normalDir:hv.nDir,depth:0,curX:hv.gx,curY:hv.gy,curZ:hv.gz};
      eControls.enabled=false;eRenderer.domElement.style.cursor='move';updateStretchGhost()}}});

eRenderer.domElement.addEventListener('pointermove',e=>{
  if(handleDrag){updateHandleDrag(e);eRenderer.domElement.style.cursor='grabbing';return}
  if(drag){const hv=hitToVoxel(e);if(hv){drag.curX=hv.gx;drag.curY=hv.gy;drag.curZ=hv.gz;updateStretchGhost()}eRenderer.domElement.style.cursor='move'}});

eRenderer.domElement.addEventListener('wheel',e=>{
  if(!drag)return;e.preventDefault();e.stopPropagation();
  drag.depth+=e.deltaY>0?1:-1;drag.depth=Math.max(0,Math.min(GX-1,drag.depth));
  updateStretchGhost();},{passive:false});

eRenderer.domElement.addEventListener('pointerup',e=>{
  if(handleDrag){commitHandleDrag();pointerDownPos=null;return}
  if(drag){
    const movedPx=pointerDownPos?Math.abs(e.clientX-pointerDownPos.x)+Math.abs(e.clientY-pointerDownPos.y):0;
    const box=getDragBox();
    if(box&&(movedPx>5||drag.depth>0)){pushUndo();fillBox(box.x1,box.y1,box.z1,box.x2,box.y2,box.z2,currentBrush);
      rebuildEditorMeshes();rebuildPreview();updateInfo();
    }else if(box&&movedPx<=5){const{sx,sy,sz}=drag;
      if(!vGet(sx,sy,sz)){pushUndo();vSet(sx,sy,sz,currentBrush);addHitMesh(sx,sy,sz);rebuildEditorMeshes();rebuildPreview();updateInfo()}}
    drag=null;stretchMesh.visible=false;stretchWire.visible=false;dragHint.style.display='none';
    eControls.enabled=true;pointerDownPos=null;updateGhost(e);return}
  if(!pointerDownPos)return;
  const dx2=e.clientX-pointerDownPos.x,dy2=e.clientY-pointerDownPos.y;pointerDownPos=null;
  if(Math.abs(dx2)>5||Math.abs(dy2)>5)return;
  if(currentTool==='cursor'){const blk=hitBlockAt(e);selectRegion(blk);return}
  if(ghostVoxel){
    const{x,y,z}=ghostVoxel;
    if(currentTool==='eraser'){pushUndo();vSet(x,y,z,0);removeHitMesh(x,y,z);rebuildEditorMeshes();rebuildPreview();updateInfo();updateGhost(e)}
  }
});
eRenderer.domElement.addEventListener('contextmenu',e=>e.preventDefault());

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  SELECTION  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function findRegionAt(x,y,z){
  if(!vGet(x,y,z))return null;
  const regs=findRegions3D();
  for(const r of regs)for(const[cx,cy,cz]of r.cells)if(cx===x&&cy===y&&cz===z)return r;
  return null;
}

function selectRegion(reg){
  selectedReg=reg;
  if(!reg){selPanel.classList.remove('open');selHighlightMesh.visible=false;if(selHighlightP)selHighlightP.visible=false;positionHandles();return}
  const info=TYPE_BY_ID[reg.typeId];
  selColor.style.background=info?info.color:'#ccc';
  selName.textContent=info?info.label:'‚Äî';
  selW.value=(reg.maxX-reg.minX+1)*10;
  selH.value=(reg.maxY-reg.minY+1)*10;
  selD.value=(reg.maxZ-reg.minZ+1)*10;
  selPanel.classList.add('open');
  updateSelHighlight();
}

function updateSelHighlight(){
  if(!selectedReg){selHighlightMesh.visible=false;if(selHighlightP)selHighlightP.visible=false;positionHandles();return}
  const r=selectedReg,{rw,rd}=getDims();
  if(!vGet(r.minX,r.minY,r.minZ)||voxels[vIdx(r.minX,r.minY,r.minZ)]!==r.typeId){
    selectRegion(null);return}
  const bx1=r.minX*CELL-rw/2,bx2=(r.maxX+1)*CELL-rw/2;
  const by1=r.minY*CELL,by2=(r.maxY+1)*CELL;
  const bz1=r.minZ*CELL-rd/2,bz2=(r.maxZ+1)*CELL-rd/2;
  const bW=bx2-bx1,bH=by2-by1,bD=bz2-bz1;
  const bcx=(bx1+bx2)/2,bcy=(by1+by2)/2,bcz=(bz1+bz2)/2;
  const g=new THREE.EdgesGeometry(new THREE.BoxGeometry(bW+.006,bH+.006,bD+.006));
  selHighlightMesh.geometry.dispose();selHighlightMesh.geometry=g;
  selHighlightMesh.position.set(bcx,bcy,bcz);selHighlightMesh.visible=true;
  if(selHighlightP){
    const gP=new THREE.EdgesGeometry(new THREE.BoxGeometry(bW+.006,bH+.006,bD+.006));
    selHighlightP.geometry.dispose();selHighlightP.geometry=gP;
    selHighlightP.position.set(bcx,bcy,bcz);selHighlightP.visible=true;
  }
  positionHandles();
}

/* selection panel events */
$('sel-apply').addEventListener('click',()=>{
  if(!selectedReg)return;
  const r=selectedReg;
  const newCellsW=Math.max(1,Math.round((+selW.value||10)/10));
  const newCellsH=Math.max(1,Math.round((+selH.value||10)/10));
  const newCellsD=Math.max(1,Math.round((+selD.value||10)/10));
  const oldCellsW=r.maxX-r.minX+1,oldCellsH=r.maxY-r.minY+1,oldCellsD=r.maxZ-r.minZ+1;
  if(newCellsW===oldCellsW&&newCellsH===oldCellsH&&newCellsD===oldCellsD)return;
  pushUndo();
  for(const[cx,cy,cz]of r.cells)vSet(cx,cy,cz,0);
  const nx2=Math.min(r.minX+newCellsW-1,GX-1);
  const ny2=Math.min(r.minY+newCellsH-1,GY-1);
  const nz2=Math.min(r.minZ+newCellsD-1,GZ-1);
  fillBox(r.minX,r.minY,r.minZ,nx2,ny2,nz2,r.typeId);
  const newReg=findRegionAt(r.minX,r.minY,r.minZ);
  selectRegion(newReg);
  rebuildEditorMeshes();rebuildPreview();updateInfo();
});
$('sel-delete').addEventListener('click',()=>{
  if(!selectedReg)return;pushUndo();
  for(const[cx,cy,cz]of selectedReg.cells)vSet(cx,cy,cz,0);
  selectRegion(null);
  rebuildEditorMeshes();rebuildPreview();updateInfo();
});
$('sel-deselect').addEventListener('click',()=>selectRegion(null));

/* Del / Backspace to delete selected block in cursor mode */
document.addEventListener('keydown',e=>{
  if((e.key==='Delete'||e.key==='Backspace')&&selectedReg&&currentTool==='cursor'&&!e.target.matches('input')){
    e.preventDefault();pushUndo();
    for(const[cx,cy,cz]of selectedReg.cells)vSet(cx,cy,cz,0);
    selectRegion(null);rebuildEditorMeshes();rebuildPreview();updateInfo()}
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PREVIEW VIEWPORT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const pScene=new THREE.Scene();pScene.background=new THREE.Color(0xf3f4f6);
let pFrust=12;
const pAspect=()=>previewVP.clientWidth/(previewVP.clientHeight||1);
const pCam=new THREE.OrthographicCamera(-pFrust*pAspect()/2,pFrust*pAspect()/2,pFrust/2,-pFrust/2,.1,1000);
pCam.position.set(12,12,12);pCam.lookAt(0,0,0);
const pRenderer=new THREE.WebGLRenderer({antialias:true});
pRenderer.setPixelRatio(window.devicePixelRatio);
pRenderer.setSize(previewVP.clientWidth,previewVP.clientHeight);
previewVP.appendChild(pRenderer.domElement);
const pControls=new OrbitControls(pCam,pRenderer.domElement);
pControls.enableDamping=true;pControls.dampingFactor=.12;
const pFloor=new THREE.Group();pScene.add(pFloor);
const pVoxG=new THREE.Group();pScene.add(pVoxG);
const pDetailG=new THREE.Group();pScene.add(pDetailG);
selHighlightP=new THREE.LineSegments(new THREE.EdgesGeometry(unitBox),selHighlightMat.clone());
selHighlightP.visible=false;pScene.add(selHighlightP);

function buildPreviewFloor(){
  pFloor.clear();const{rw,rd}=getDims();
  const pts=[];
  for(let i=0;i<=GX;i++){const x=i*CELL-rw/2;pts.push(new THREE.Vector3(x,0,-rd/2),new THREE.Vector3(x,0,rd/2))}
  for(let j=0;j<=GZ;j++){const z=j*CELL-rd/2;pts.push(new THREE.Vector3(-rw/2,0,z),new THREE.Vector3(rw/2,0,z))}
  pFloor.add(new THREE.LineSegments(new THREE.BufferGeometry().setFromPoints(pts),RM))}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  FLOOD FILL  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function findRegions3D(){
  const vis=new Uint8Array(GX*GY*GZ),regs=[];
  for(let z=0;z<GZ;z++)for(let y=0;y<GY;y++)for(let x=0;x<GX;x++){
    const idx=vIdx(x,y,z);if(vis[idx]||!voxels[idx])continue;
    const tid=voxels[idx],cells=[],q=[[x,y,z]];vis[idx]=1;
    while(q.length){const[cx,cy,cz]=q.shift();cells.push([cx,cy,cz]);
      for(const[dx,dy,dz]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]]){
        const nx=cx+dx,ny=cy+dy,nz=cz+dz;
        if(nx<0||nx>=GX||ny<0||ny>=GY||nz<0||nz>=GZ)continue;
        const ni=vIdx(nx,ny,nz);if(vis[ni]||voxels[ni]!==tid)continue;vis[ni]=1;q.push([nx,ny,nz])}}
    let minX=GX,maxX=0,minY=GY,maxY=0,minZ=GZ,maxZ=0;
    for(const[cx,cy,cz]of cells){minX=Math.min(minX,cx);maxX=Math.max(maxX,cx);
      minY=Math.min(minY,cy);maxY=Math.max(maxY,cy);minZ=Math.min(minZ,cz);maxZ=Math.max(maxZ,cz)}
    regs.push({typeId:tid,cells,minX,maxX,minY,maxY,minZ,maxZ})}
  return regs}

function findFrontFace(reg){
  let faces={nx:0,px:0,nz:0,pz:0};
  for(const[x,y,z]of reg.cells){
    if(x===reg.minX&&!vGet(x-1,y,z))faces.nx++;
    if(x===reg.maxX&&!vGet(x+1,y,z))faces.px++;
    if(z===reg.minZ&&!vGet(x,y,z-1))faces.nz++;
    if(z===reg.maxZ&&!vGet(x,y,z+1))faces.pz++;}
  let best='pz',bv=faces.pz;
  if(faces.nz>bv){best='nz';bv=faces.nz}if(faces.px>bv){best='px';bv=faces.px}if(faces.nx>bv){best='nx'}
  return best}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  PREVIEW BUILD  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rebuildPreview(){
  pVoxG.clear();pDetailG.clear();buildPreviewFloor();
  const{rw,rd,h}=getDims();const WALL=.015;
  const tShelf=(+shelfHEl.value||30)/100,tDrawer=(+drawerHEl.value||20)/100,
    tShoe=(+shoeHEl.value||18)/100,tBoot=(+bootHEl.value||35)/100,
    tBook=(+bookHEl.value||30)/100,tOpen=(+openHEl.value||35)/100;
  const regs=findRegions3D();
  $('info-regions').textContent=regs.length;
  for(const reg of regs){
    const info=TYPE_BY_ID[reg.typeId];if(!info)continue;
    const bx1=reg.minX*CELL-rw/2,bx2=(reg.maxX+1)*CELL-rw/2;
    const by1=reg.minY*CELL,by2=(reg.maxY+1)*CELL;
    const bz1=reg.minZ*CELL-rd/2,bz2=(reg.maxZ+1)*CELL-rd/2;
    const bW=bx2-bx1-GAP,bH=by2-by1-GAP,bD=bz2-bz1-GAP;
    const bcx=(bx1+bx2)/2,bcy=(by1+by2)/2,bcz=(bz1+bz2)/2;
    const inW=bW-WALL*4,inH=bH-WALL*4,inD=bD-WALL*4;
    const front=frontOverride==='auto'?findFrontFace(reg):frontOverride;
    const bm=new THREE.Mesh(new THREE.BoxGeometry(bW,bH,bD),getColorMat(info.color));
    bm.renderOrder=0;bm.position.set(bcx,bcy,bcz);pVoxG.add(bm);
    const bwire=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(bW,bH,bD)),TM);
    bwire.renderOrder=1;bwire.position.set(bcx,bcy,bcz);pVoxG.add(bwire);
    switch(info.key){
      case 'shelf':case 'open':{
        const tgt=info.key==='shelf'?tShelf:tOpen;
        if(splitH){const n=Math.max(1,Math.round(bH/tgt));for(let i=1;i<n;i++)wb(pDetailG,inW,WALL,inD,bcx,by1+bH*i/n,bcz)}
        if(splitW&&bW>CELL*4)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);
        if(splitD&&bD>CELL*4)wb(pDetailG,inW,inH,WALL,bcx,bcy,bcz);break}
      case 'books':{
        if(splitH){const n=Math.max(1,Math.round(bH/tBook));for(let i=1;i<n;i++)wb(pDetailG,inW,WALL,inD,bcx,by1+bH*i/n,bcz)}
        if(splitW&&bW>CELL*3)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);
        if(splitD&&bD>CELL*3)wb(pDetailG,inW,inH,WALL,bcx,bcy,bcz);break}
      case 'hanging':{
        const ry=by2-bH*.1;const rodLen=front==='nz'||front==='pz'?inW:inD;
        const rg=new THREE.CylinderGeometry(.01,.01,rodLen,8);
        if(front==='nz'||front==='pz')rg.rotateZ(Math.PI/2);else rg.rotateX(Math.PI/2);
        const rod=new THREE.LineSegments(new THREE.EdgesGeometry(rg),LM);rod.position.set(bcx,ry,bcz);pDetailG.add(rod);
        wb(pDetailG,inW,WALL,inD,bcx,by2-WALL*2,bcz);
        if(splitW&&bW>CELL*4)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);break}
      case 'drawer':{
        if(splitH){const n=Math.max(1,Math.round(bH/tDrawer));const gap=WALL,dH=(bH-gap*(n+1))/n;
          let ffx=bcx,ffz=bcz;
          if(front==='nz')ffz=bz1+WALL;else if(front==='pz')ffz=bz2-WALL;
          else if(front==='nx')ffx=bx1+WALL;else ffx=bx2-WALL;
          for(let i=0;i<n;i++){const dy=by1+gap+dH/2+i*(dH+gap);
            if(front==='nz'||front==='pz'){wb(pDetailG,inW,dH-WALL,WALL,bcx,dy,ffz);
              wb(pDetailG,inW*.22,WALL,WALL,bcx,dy,ffz+(front==='pz'?WALL:-WALL))}
            else{wb(pDetailG,WALL,dH-WALL,inD,ffx,dy,bcz);
              wb(pDetailG,WALL,WALL,inD*.22,ffx+(front==='px'?WALL:-WALL),dy,bcz)}}}
        if(splitW&&bW>CELL*4)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);break}
      case 'shoeLow':case 'shoeHi':{
        const tgt=info.key==='shoeLow'?tShoe:tBoot;
        if(splitH){const n=Math.max(1,Math.round(bH/tgt));
          for(let i=1;i<n;i++) wb(pDetailG,inW,WALL,inD,bcx,by1+bH*i/n,bcz)}
        if(splitW&&bW>CELL*4)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);
        if(splitD&&bD>CELL*4)wb(pDetailG,inW,inH,WALL,bcx,bcy,bcz);break}
      case 'top':{if(splitH)wb(pDetailG,inW,WALL,inD,bcx,bcy,bcz);
        if(splitW&&bW>CELL*4)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);break}
      case 'sink':{
        const basinH=bH*.2,basinW=inW*.65,basinD=inD*.65;
        const bl=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(basinW,basinH,basinD)),TM);
        bl.position.set(bcx,by2-basinH/2-WALL,bcz);pDetailG.add(bl);
        const fH=bH*.3,fG=new THREE.CylinderGeometry(.006,.006,fH,6);
        const fL=new THREE.LineSegments(new THREE.EdgesGeometry(fG),LM);
        let faucZ=bcz,faucX=bcx;
        if(front==='nz')faucZ=bz1+inD*.2;else if(front==='pz')faucZ=bz2-inD*.2;
        else if(front==='nx')faucX=bx1+inW*.2;else faucX=bx2-inW*.2;
        fL.position.set(faucX,by2+fH/2-WALL,faucZ);pDetailG.add(fL);break}
      case 'cooktop':{
        wb(pDetailG,inW*.9,WALL*2,inD*.9,bcx,by2-WALL*2,bcz,LM);
        const bR=Math.min(inW,inD)*.16,offX=inW*.2,offZ=inD*.2;
        for(const[dx2,dz2]of[[-1,-1],[-1,1],[1,-1],[1,1]]){
          const cg=new THREE.RingGeometry(bR*.5,bR,16);cg.rotateX(-Math.PI/2);
          const cl=new THREE.LineSegments(new THREE.EdgesGeometry(cg),TM);
          cl.position.set(bcx+dx2*offX,by2-WALL,bcz+dz2*offZ);pDetailG.add(cl)}break}
      case 'oven':{
        let dx=0,dz=0;
        if(front==='nz')dz=bz1+WALL;else if(front==='pz')dz=bz2-WALL;
        else if(front==='nx')dx=bx1+WALL;else dx=bx2-WALL;
        if(front==='nz'||front==='pz'){wb(pDetailG,inW-WALL*4,inH-WALL*4,WALL,bcx,bcy,dz);
          wb(pDetailG,inW*.45,WALL,WALL,bcx,by2-bH*.15,dz+(front==='pz'?WALL:-WALL),LM)}
        else{wb(pDetailG,WALL,inH-WALL*4,inD-WALL*4,dx,bcy,bcz);
          wb(pDetailG,WALL,WALL,inD*.45,dx+(front==='px'?WALL:-WALL),by2-bH*.15,bcz,LM)}
        wb(pDetailG,inW*.8,WALL,inD*.8,bcx,bcy,bcz);break}
      case 'door':case 'doorGlass':{
        /* door panel on front face */
        const isGlass=info.key==='doorGlass';
        let dPx=bcx,dPz=bcz,dW2=inW,dH2=inH,dD2=inD;
        const doorGap=WALL*2;
        if(front==='nz'||front==='pz'){
          dPz=front==='nz'?bz1+WALL:bz2-WALL;
          /* door panel: full-height face */
          wb(pDetailG,inW-doorGap,inH-doorGap,WALL,bcx,bcy,dPz,isGlass?RM:TM);
          /* handle */
          const hx=bcx+(front==='pz'?-1:1)*(inW/2-WALL*6);
          const hG=new THREE.CylinderGeometry(.008,.008,bH*.12,6);
          const hL=new THREE.LineSegments(new THREE.EdgesGeometry(hG),LM);
          hL.position.set(hx,bcy,dPz+(front==='pz'?WALL*2:-WALL*2));pDetailG.add(hL);
          /* hinge lines */
          const hingX=bcx+(front==='pz'?1:-1)*(inW/2-WALL);
          for(const hy of[by1+WALL*6,by2-WALL*6]){
            const hiG=new THREE.CylinderGeometry(.005,.005,WALL*4,4);
            const hiL=new THREE.LineSegments(new THREE.EdgesGeometry(hiG),TM);
            hiL.position.set(hingX,hy,dPz);pDetailG.add(hiL)}
          /* glass pane */
          if(isGlass){
            const gm=new THREE.Mesh(new THREE.PlaneGeometry(inW*.7,inH*.7),
              new THREE.MeshBasicMaterial({color:0xb8d8e8,transparent:true,opacity:.15,side:THREE.DoubleSide}));
            gm.position.set(bcx,bcy,dPz);pDetailG.add(gm)}
        }else{
          dPx=front==='nx'?bx1+WALL:bx2-WALL;
          wb(pDetailG,WALL,inH-doorGap,inD-doorGap,dPx,bcy,bcz,isGlass?RM:TM);
          const hz=bcz+(front==='px'?-1:1)*(inD/2-WALL*6);
          const hG=new THREE.CylinderGeometry(.008,.008,bH*.12,6);
          const hL=new THREE.LineSegments(new THREE.EdgesGeometry(hG),LM);
          hL.position.set(dPx+(front==='px'?WALL*2:-WALL*2),bcy,hz);pDetailG.add(hL);
          const hingZ=bcz+(front==='px'?1:-1)*(inD/2-WALL);
          for(const hy of[by1+WALL*6,by2-WALL*6]){
            const hiG=new THREE.CylinderGeometry(.005,.005,WALL*4,4);
            const hiL=new THREE.LineSegments(new THREE.EdgesGeometry(hiG),TM);
            hiL.position.set(dPx,hy,hingZ);pDetailG.add(hiL)}
          if(isGlass){
            const gm=new THREE.Mesh(new THREE.PlaneGeometry(inD*.7,inH*.7),
              new THREE.MeshBasicMaterial({color:0xb8d8e8,transparent:true,opacity:.15,side:THREE.DoubleSide}));
            gm.rotation.y=Math.PI/2;
            gm.position.set(dPx,bcy,bcz);pDetailG.add(gm)}
        }
        if(splitW&&bW>CELL*4)wb(pDetailG,WALL,inH,inD,bcx,bcy,bcz);
        break}
      case 'dishw':{
        let dx=0,dz=0;
        if(front==='nz')dz=bz1+WALL;else if(front==='pz')dz=bz2-WALL;
        else if(front==='nx')dx=bx1+WALL;else dx=bx2-WALL;
        if(front==='nz'||front==='pz'){wb(pDetailG,inW-WALL*4,inH-WALL*4,WALL,bcx,bcy,dz);
          wb(pDetailG,inW*.35,WALL,WALL,bcx,by2-bH*.12,dz+(front==='pz'?WALL:-WALL),LM)}
        else{wb(pDetailG,WALL,inH-WALL*4,inD-WALL*4,dx,bcy,bcz);
          wb(pDetailG,WALL,WALL,inD*.35,dx+(front==='px'?WALL:-WALL),by2-bH*.12,bcz,LM)}
        if(splitH){wb(pDetailG,inW*.8,WALL,inD*.8,bcx,by1+bH*.35,bcz);wb(pDetailG,inW*.8,WALL,inD*.8,bcx,by1+bH*.65,bcz)}break}
    }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  INFO  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateInfo(){
  let minX=GX,maxX=-1,minY=GY,maxY=-1,minZ=GZ,maxZ=-1;
  for(let z=0;z<GZ;z++)for(let y=0;y<GY;y++)for(let x=0;x<GX;x++){
    if(!vGet(x,y,z))continue;minX=Math.min(minX,x);maxX=Math.max(maxX,x);
    minY=Math.min(minY,y);maxY=Math.max(maxY,y);minZ=Math.min(minZ,z);maxZ=Math.max(maxZ,z)}
  if(maxX<0){$('auto-w').textContent=$('auto-h').textContent=$('auto-d').textContent='‚Äî';$('info-size').textContent='‚Äî';return}
  const w=(maxX-minX+1)*10,ht=(maxY-minY+1)*10,d=(maxZ-minZ+1)*10;
  $('auto-w').textContent=w;$('auto-h').textContent=ht;$('auto-d').textContent=d;
  $('info-size').textContent=`${w}√ó${ht}√ó${d} —Å–º`}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  REBUILD  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let timer=0;
function scheduleRebuild(){clearTimeout(timer);timer=setTimeout(fullRebuild,80)}
function fullRebuild(){buildEditorFloor();rebuildEditorMeshes();rebuildPreview();updateInfo();fitCams()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  CAMERAS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fitCams(){
  const{rw,rd,h}=getDims();const sz=Math.max(rw,rd,h);
  eFrust=sz*1.6;updateEditorFrustum();eControls.target.set(0,h/2,0);eControls.update();
  pFrust=sz*1.6;updatePreviewFrustum();pControls.target.set(0,h/2,0);pControls.update()}
function updateEditorFrustum(){const a=eAspect();eCam.left=-eFrust*a/2;eCam.right=eFrust*a/2;eCam.top=eFrust/2;eCam.bottom=-eFrust/2;eCam.updateProjectionMatrix()}
function updatePreviewFrustum(){const a=pAspect();pCam.left=-pFrust*a/2;pCam.right=pFrust*a/2;pCam.top=pFrust/2;pCam.bottom=-pFrust/2;pCam.updateProjectionMatrix()}

$('btn-reset-cam').addEventListener('click',()=>{const{h}=getDims();
  eCam.position.set(10,10,10);eControls.target.set(0,h/2,0);eControls.update();
  pCam.position.set(12,12,12);pControls.target.set(0,h/2,0);pControls.update()});

function onResize(){
  eRenderer.setSize(editorVP.clientWidth,editorVP.clientHeight);updateEditorFrustum();
  pRenderer.setSize(previewVP.clientWidth,previewVP.clientHeight);updatePreviewFrustum()}
window.addEventListener('resize',onResize);
new ResizeObserver(onResize).observe(editorVP);
new ResizeObserver(onResize).observe(previewVP);

(function animate(){requestAnimationFrame(animate);
  eControls.update();eRenderer.render(eScene,eCam);
  pControls.update();pRenderer.render(pScene,pCam)})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  SAVE / LOAD  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveProject(){
  const data={
    version:2,
    grid:{gx:GX,gy:GY,gz:GZ},
    voxels:Array.from(voxels),
    settings:{
      category:currentCat,
      roomW:+roomWEl.value,roomD:+roomDEl.value,dimH:+dimHEl.value,
      splitH,splitW,splitD,
      shelfH:+shelfHEl.value,drawerH:+drawerHEl.value,openH:+openHEl.value,
      shoeH:+shoeHEl.value,bootH:+bootHEl.value,bookH:+bookHEl.value,
      frontOverride
    }
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  const ts=new Date().toISOString().slice(0,16).replace(/[T:]/g,'-');
  a.download=`furniture-${currentCat}-${ts}.json`;
  a.click();URL.revokeObjectURL(a.href);
}

function loadProject(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const data=JSON.parse(reader.result);
      if(!data.grid||!data.voxels)throw new Error('Invalid format');
      pushUndo();
      GX=data.grid.gx;GY=data.grid.gy;GZ=data.grid.gz;
      voxels=new Uint8Array(data.voxels);
      if(data.settings){
        const s=data.settings;
        if(s.category){currentCat=s.category;
          document.querySelector('.cat-btn.active')?.classList.remove('active');
          document.querySelector(`.cat-btn[data-cat="${s.category}"]`)?.classList.add('active');
          buildPalette();buildPresets()}
        if(s.roomW){roomWEl.value=s.roomW}
        if(s.roomD){roomDEl.value=s.roomD}
        if(s.dimH){dimHEl.value=s.dimH}
        if(s.splitH!==undefined){splitH=s.splitH;togH.classList.toggle('on',splitH)}
        if(s.splitW!==undefined){splitW=s.splitW;togW.classList.toggle('on',splitW)}
        if(s.splitD!==undefined){splitD=s.splitD;togD.classList.toggle('on',splitD)}
        if(s.shelfH)shelfHEl.value=s.shelfH;
        if(s.drawerH)drawerHEl.value=s.drawerH;
        if(s.openH)openHEl.value=s.openH;
        if(s.shoeH)shoeHEl.value=s.shoeH;
        if(s.bootH)bootHEl.value=s.bootH;
        if(s.bookH)bookHEl.value=s.bookH;
        if(s.frontOverride){frontOverride=s.frontOverride;
          document.querySelectorAll('[data-front]').forEach(bb=>{bb.classList.toggle('on',bb.dataset.front===frontOverride);bb.querySelector('.indicator').style.background=bb.dataset.front===frontOverride?'#000':'#fff'})}
      }
      $('grid-info').textContent=`${GX}√ó${GY}√ó${GZ}`;
      selectRegion(null);fullRebuild();
    }catch(err){alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+err.message)}
  };
  reader.readAsText(file);
}

$('btn-save').addEventListener('click',saveProject);
$('btn-load').addEventListener('click',()=>$('file-input').click());
$('file-input').addEventListener('change',e=>{
  const f=e.target.files[0];if(f)loadProject(f);e.target.value='';});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  EXPORT HELPERS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getVoxBounds(){
  let minVX=GX,maxVX=0,minVY=GY,maxVY=0,minVZ=GZ,maxVZ=0;
  for(let z=0;z<GZ;z++)for(let y=0;y<GY;y++)for(let x=0;x<GX;x++){
    if(!vGet(x,y,z))continue;
    minVX=Math.min(minVX,x);maxVX=Math.max(maxVX,x);
    minVY=Math.min(minVY,y);maxVY=Math.max(maxVY,y);
    minVZ=Math.min(minVZ,z);maxVZ=Math.max(maxVZ,z)}
  return{minVX,maxVX,minVY,maxVY,minVZ,maxVZ,
    cW:maxVX-minVX+1,cH:maxVY-minVY+1,cD:maxVZ-minVZ+1,empty:maxVX<minVX};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  EXPORT BLUEPRINT (PNG)  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportBlueprint(){
  const regs=findRegions3D();
  if(!regs.length){alert('–ù–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Å—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞');return}
  const b=getVoxBounds();if(b.empty)return;
  const{minVX,maxVX,minVY,maxVY,minVZ,maxVZ,cW,cH,cD}=b;
  const pxPerCm=4;
  const pad=70,gap=60,dimOff=30,fontSize=12;

  /* region sizes in cm */
  const wCm=cW*10,hCm=cH*10,dCm=cD*10;
  const fW=wCm*pxPerCm,fH=hCm*pxPerCm;
  const sW=dCm*pxPerCm,sH=hCm*pxPerCm;
  const tW=wCm*pxPerCm,tH=dCm*pxPerCm;

  const totalW=pad*2+fW+gap+sW;
  const totalH=pad*2+fH+gap+tH+gap+40;

  const cvs=$('export-canvas');
  cvs.width=totalW;cvs.height=totalH;
  const ctx=cvs.getContext('2d');
  ctx.fillStyle='#fff';ctx.fillRect(0,0,totalW,totalH);
  ctx.textAlign='center';ctx.textBaseline='middle';

  function drawDimLine(x1,y1,x2,y2,label){
    const tk=6;
    ctx.strokeStyle='#000';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
    if(y1===y2){
      ctx.beginPath();ctx.moveTo(x1,y1-tk);ctx.lineTo(x1,y1+tk);ctx.stroke();
      ctx.beginPath();ctx.moveTo(x2,y2-tk);ctx.lineTo(x2,y2+tk);ctx.stroke();
      ctx.fillStyle='#000';ctx.font=`${fontSize}px "SF Mono","Courier New",monospace`;
      ctx.fillText(label,(x1+x2)/2,y1+16);
    }else{
      ctx.beginPath();ctx.moveTo(x1-tk,y1);ctx.lineTo(x1+tk,y1);ctx.stroke();
      ctx.beginPath();ctx.moveTo(x2-tk,y2);ctx.lineTo(x2+tk,y2);ctx.stroke();
      ctx.fillStyle='#000';ctx.font=`${fontSize}px "SF Mono","Courier New",monospace`;
      ctx.save();ctx.translate(x1-16,(y1+y2)/2);ctx.rotate(-Math.PI/2);ctx.fillText(label,0,0);ctx.restore();
    }
  }

  function drawRegView(ox,oy,title,getRect){
    /* title */
    ctx.fillStyle='#000';ctx.font=`bold ${fontSize+2}px "SF Mono","Courier New",monospace`;
    ctx.textAlign='center';
    const titleX=ox+(title.includes('–°–ü–ï–†')? fW/2 : title.includes('–°–ë–û–ö')? sW/2 : tW/2);
    ctx.fillText(title,titleX,oy-22);
    /* regions */
    for(const reg of regs){
      const info=TYPE_BY_ID[reg.typeId];if(!info)continue;
      const rc=getRect(reg);if(!rc)continue;
      /* filled rect */
      ctx.fillStyle=info.color;ctx.fillRect(rc.x,rc.y,rc.w,rc.h);
      /* outline */
      ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.strokeRect(rc.x,rc.y,rc.w,rc.h);
      /* dim label + type name */
      ctx.fillStyle='#000';ctx.font=`bold ${fontSize}px "SF Mono","Courier New",monospace`;
      ctx.textAlign='center';
      ctx.fillText(`${Math.round(rc.w/pxPerCm)}√ó${Math.round(rc.h/pxPerCm)}`,rc.x+rc.w/2,rc.y+rc.h/2-8);
      ctx.font=`${fontSize-1}px "SF Mono","Courier New",monospace`;
      ctx.fillText(info.label,rc.x+rc.w/2,rc.y+rc.h/2+8);
    }
  }

  /* FRONT (–®√ó–í): X‚Üícol, Y‚Üírow */
  const fOx=pad,fOy=pad;
  drawRegView(fOx,fOy,'–í–ò–î –°–ü–ï–†–ï–î–ò (–®√ó–í)',reg=>{
    const rx=(reg.minX-minVX)*10*pxPerCm,rw=(reg.maxX-reg.minX+1)*10*pxPerCm;
    const ry=(cH-(reg.maxY-minVY+1))*10*pxPerCm,rh=(reg.maxY-reg.minY+1)*10*pxPerCm;
    return{x:fOx+rx,y:fOy+ry,w:rw,h:rh};});
  drawDimLine(fOx,fOy+fH+dimOff,fOx+fW,fOy+fH+dimOff,`${wCm} —Å–º`);
  drawDimLine(fOx-dimOff,fOy,fOx-dimOff,fOy+fH,`${hCm} —Å–º`);
  /* per-region width dims along bottom */
  ctx.lineWidth=1;ctx.strokeStyle='#666';
  const frontRegsX=[...regs].sort((a,b)=>a.minX-b.minX);
  let prevEndX=-1;
  for(const reg of frontRegsX){
    const rx=fOx+(reg.minX-minVX)*10*pxPerCm;
    const rw=(reg.maxX-reg.minX+1)*10*pxPerCm;
    if(rx>prevEndX+1)drawDimLine(rx,fOy+fH+dimOff+20,rx+rw,fOy+fH+dimOff+20,`${(reg.maxX-reg.minX+1)*10}`);
    prevEndX=Math.max(prevEndX,rx+rw);
  }

  /* SIDE (–ì√ó–í): Z‚Üícol, Y‚Üírow */
  const sOx=pad+fW+gap,sOy=pad;
  drawRegView(sOx,sOy,'–í–ò–î –°–ë–û–ö–£ (–ì√ó–í)',reg=>{
    const rx=(reg.minZ-minVZ)*10*pxPerCm,rw=(reg.maxZ-reg.minZ+1)*10*pxPerCm;
    const ry=(cH-(reg.maxY-minVY+1))*10*pxPerCm,rh=(reg.maxY-reg.minY+1)*10*pxPerCm;
    return{x:sOx+rx,y:sOy+ry,w:rw,h:rh};});
  drawDimLine(sOx,sOy+sH+dimOff,sOx+sW,sOy+sH+dimOff,`${dCm} —Å–º`);
  drawDimLine(sOx+sW+dimOff,sOy,sOx+sW+dimOff,sOy+sH,`${hCm} —Å–º`);

  /* TOP (–®√ó–ì): X‚Üícol, Z‚Üírow */
  const tOx=pad,tOy=pad+fH+gap;
  drawRegView(tOx,tOy,'–í–ò–î –°–í–ï–†–•–£ (–®√ó–ì)',reg=>{
    const rx=(reg.minX-minVX)*10*pxPerCm,rw=(reg.maxX-reg.minX+1)*10*pxPerCm;
    const ry=(cD-(reg.maxZ-minVZ+1))*10*pxPerCm,rh=(reg.maxZ-reg.minZ+1)*10*pxPerCm;
    return{x:tOx+rx,y:tOy+ry,w:rw,h:rh};});
  drawDimLine(tOx,tOy+tH+dimOff,tOx+tW,tOy+tH+dimOff,`${wCm} —Å–º`);
  drawDimLine(tOx-dimOff,tOy,tOx-dimOff,tOy+tH,`${dCm} —Å–º`);

  /* legend */
  const legY=tOy+tH+gap;
  ctx.font=`bold ${fontSize}px "SF Mono","Courier New",monospace`;
  ctx.textAlign='left';
  let legX=pad;
  const usedTypes=new Set(regs.map(r=>r.typeId));
  for(const tid of usedTypes){
    const info=TYPE_BY_ID[tid];if(!info)continue;
    ctx.fillStyle=info.color;ctx.fillRect(legX,legY,14,14);
    ctx.strokeStyle='#000';ctx.lineWidth=1;ctx.strokeRect(legX,legY,14,14);
    ctx.fillStyle='#000';ctx.fillText(info.label,legX+18,legY+10);
    legX+=ctx.measureText(info.label).width+36;
  }
  ctx.textAlign='center';
  $('export-overlay').classList.add('open');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  EXPORT DXF (AutoCAD)  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportDXF(){
  const regs=findRegions3D();
  if(!regs.length){alert('–ù–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Å—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞');return}
  const b=getVoxBounds();if(b.empty)return;
  const{minVX,minVY,minVZ,cW,cH,cD}=b;
  /* DXF uses mm; our cells = 10cm = 100mm */
  const mm=100;
  let eid=100;
  const ne=()=>String(eid++);
  const lines=[];
  const L=(...a)=>{for(const s of a)lines.push(s)};

  /* ---- HEADER ---- */
  L('0','SECTION','2','HEADER',
    '9','$ACADVER','1','AC1015',
    '9','$INSUNITS','70','4',
    '0','ENDSEC');

  /* ---- TABLES (layers) ---- */
  L('0','SECTION','2','TABLES','0','TABLE','2','LAYER','70',String(Object.keys(TYPE_BY_ID).length+3));
  /* layer 0 */
  L('0','LAYER','2','0','70','0','62','7','6','Continuous');
  /* DIM layer */
  L('0','LAYER','2','DIM','70','0','62','1','6','Continuous');
  /* TEXT layer */
  L('0','LAYER','2','TEXT','70','0','62','7','6','Continuous');
  /* per-type layers */
  function hexToAci(hex){
    const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),bl=parseInt(hex.slice(5,7),16);
    if(r>200&&g<100&&bl<100)return 1;/*red*/
    if(r>200&&g>200&&bl<100)return 2;/*yellow*/
    if(r<100&&g>200&&bl<100)return 3;/*green*/
    if(r<100&&g>200&&bl>200)return 4;/*cyan*/
    if(r<100&&g<100&&bl>200)return 5;/*blue*/
    if(r>200&&g<100&&bl>200)return 6;/*magenta*/
    if(r>180&&g>180&&bl>180)return 9;/*lt grey*/
    if(r>150&&g>100)return 40;/*orange-ish*/
    return 7;
  }
  for(const[id,info]of Object.entries(TYPE_BY_ID)){
    L('0','LAYER','2',info.label.replace(/\s/g,'_'),'70','0','62',String(hexToAci(info.color)),'6','Continuous');
  }
  L('0','ENDTAB','0','ENDSEC');

  /* ---- ENTITIES ---- */
  L('0','SECTION','2','ENTITIES');

  function addRect(layer,x1,y1,x2,y2){
    L('0','LWPOLYLINE','5',ne(),'8',layer,'90','4','70','1');
    L('10',String(x1),'20',String(y1));
    L('10',String(x2),'20',String(y1));
    L('10',String(x2),'20',String(y2));
    L('10',String(x1),'20',String(y2));
  }
  function addText(layer,x,y,h,txt){
    L('0','TEXT','5',ne(),'8',layer,
      '10',String(x),'20',String(y),'40',String(h),
      '1',txt,'72','1','11',String(x),'21',String(y));
  }
  function addDimH(x1,x2,y,label){
    addRect('DIM',x1,y-2,x2,y+2);
    L('0','LINE','5',ne(),'8','DIM','10',String(x1),'20',String(y-10),'11',String(x1),'21',String(y+10));
    L('0','LINE','5',ne(),'8','DIM','10',String(x2),'20',String(y-10),'11',String(x2),'21',String(y+10));
    addText('DIM',(x1+x2)/2,y+18,25,label);
  }
  function addDimV(x,y1,y2,label){
    addRect('DIM',x-2,y1,x+2,y2);
    L('0','LINE','5',ne(),'8','DIM','10',String(x-10),'20',String(y1),'11',String(x+10),'21',String(y1));
    L('0','LINE','5',ne(),'8','DIM','10',String(x-10),'20',String(y2),'11',String(x+10),'21',String(y2));
    addText('DIM',x-20,(y1+y2)/2,25,label);
  }

  /* offsets for 3 views */
  const frontOffX=0,frontOffY=0;
  const sideOffX=(cW*mm)+500,sideOffY=0;
  const topOffX=0,topOffY=-(cH*mm)-500;

  /* FRONT (X‚Üícol, Y‚Üírow) */
  addText('TEXT',frontOffX+(cW*mm)/2,frontOffY+cH*mm+80,35,'–í–ò–î –°–ü–ï–†–ï–î–ò');
  for(const reg of regs){
    const info=TYPE_BY_ID[reg.typeId];if(!info)continue;
    const ln=info.label.replace(/\s/g,'_');
    const x1=frontOffX+(reg.minX-minVX)*mm,x2=frontOffX+(reg.maxX-minVX+1)*mm;
    const y1=frontOffY+(reg.minY-minVY)*mm,y2=frontOffY+(reg.maxY-minVY+1)*mm;
    addRect(ln,x1,y1,x2,y2);
    addText(ln,(x1+x2)/2,(y1+y2)/2,20,`${(reg.maxX-reg.minX+1)*10}x${(reg.maxY-reg.minY+1)*10}`);
    addText(ln,(x1+x2)/2,(y1+y2)/2-30,18,info.label);
  }
  addDimH(frontOffX,frontOffX+cW*mm,frontOffY-60,`${cW*10}`);
  addDimV(frontOffX-60,frontOffY,frontOffY+cH*mm,`${cH*10}`);

  /* SIDE (Z‚Üícol, Y‚Üírow) */
  addText('TEXT',sideOffX+(cD*mm)/2,sideOffY+cH*mm+80,35,'–í–ò–î –°–ë–û–ö–£');
  for(const reg of regs){
    const info=TYPE_BY_ID[reg.typeId];if(!info)continue;
    const ln=info.label.replace(/\s/g,'_');
    const x1=sideOffX+(reg.minZ-minVZ)*mm,x2=sideOffX+(reg.maxZ-minVZ+1)*mm;
    const y1=sideOffY+(reg.minY-minVY)*mm,y2=sideOffY+(reg.maxY-minVY+1)*mm;
    addRect(ln,x1,y1,x2,y2);
    addText(ln,(x1+x2)/2,(y1+y2)/2,20,`${(reg.maxZ-reg.minZ+1)*10}x${(reg.maxY-reg.minY+1)*10}`);
    addText(ln,(x1+x2)/2,(y1+y2)/2-30,18,info.label);
  }
  addDimH(sideOffX,sideOffX+cD*mm,sideOffY-60,`${cD*10}`);
  addDimV(sideOffX+cD*mm+60,sideOffY,sideOffY+cH*mm,`${cH*10}`);

  /* TOP (X‚Üícol, Z‚Üírow) */
  addText('TEXT',topOffX+(cW*mm)/2,topOffY+cD*mm+80,35,'–í–ò–î –°–í–ï–†–•–£');
  for(const reg of regs){
    const info=TYPE_BY_ID[reg.typeId];if(!info)continue;
    const ln=info.label.replace(/\s/g,'_');
    const x1=topOffX+(reg.minX-minVX)*mm,x2=topOffX+(reg.maxX-minVX+1)*mm;
    const y1=topOffY+(reg.minZ-minVZ)*mm,y2=topOffY+(reg.maxZ-minVZ+1)*mm;
    addRect(ln,x1,y1,x2,y2);
    addText(ln,(x1+x2)/2,(y1+y2)/2,20,`${(reg.maxX-reg.minX+1)*10}x${(reg.maxZ-reg.minZ+1)*10}`);
    addText(ln,(x1+x2)/2,(y1+y2)/2-30,18,info.label);
  }
  addDimH(topOffX,topOffX+cW*mm,topOffY-60,`${cW*10}`);
  addDimV(topOffX-60,topOffY,topOffY+cD*mm,`${cD*10}`);

  L('0','ENDSEC','0','EOF');

  const dxf=lines.join('\n');
  const blob=new Blob([dxf],{type:'application/dxf'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  const ts=new Date().toISOString().slice(0,16).replace(/[T:]/g,'-');
  a.download=`blueprint-${currentCat}-${ts}.dxf`;
  a.click();URL.revokeObjectURL(a.href);
}

$('btn-export').addEventListener('click',exportBlueprint);
$('export-close').addEventListener('click',()=>$('export-overlay').classList.remove('open'));
$('export-overlay').addEventListener('click',e=>{if(e.target===$('export-overlay'))$('export-overlay').classList.remove('open')});
$('export-download').addEventListener('click',()=>{
  const cvs=$('export-canvas');
  const a=document.createElement('a');a.href=cvs.toDataURL('image/png');
  const ts=new Date().toISOString().slice(0,16).replace(/[T:]/g,'-');
  a.download=`blueprint-${currentCat}-${ts}.png`;a.click();
});
$('export-dxf').addEventListener('click',exportDXF);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  INIT  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('grid-info').textContent=`${GX}√ó${GY}√ó${GZ}`;
buildPalette();buildPresets();
const initP=CATEGORY_PRESETS.wardrobe[0];if(initP)initP.fill();
fullRebuild();
</script>
</body>
</html>
